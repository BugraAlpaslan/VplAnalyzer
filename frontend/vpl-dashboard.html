<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MSAS VPL Analyzer - Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Fira Code', monospace;
            font-weight: 500;
            background-color: #0a0a0a;
            height: 100vh;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 1fr 1fr;
            grid-template-rows: 80px 1fr;
            gap: 1px;
            padding: 0;
        }

        /* Header Area */
        .header-area {
            grid-column: 1 / 7;
            background-color: #151515;
            border-bottom: 1px solid #1f1f1f;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            color: #e0e0e0;
        }

        .header-left h1 {
            font-size: 18px;
            font-weight: 600;
        }

        .header-buttons {
            display: flex;
            gap: 10px;
        }

        .header-btn {
            background-color: #1a1a1a;
            color: #e0e0e0;
            border: 1px solid #2a2a2a;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 12px;
            font-family: 'Fira Code', monospace;
            transition: background-color 0.2s ease;
        }

        .header-btn:hover {
            background-color: #2a2a2a;
        }

        .header-btn:disabled {
            background-color: #1a1a1a;
            color: #555;
            cursor: not-allowed;
        }

        /* Left Sidebar */
        .sidebar {
            grid-column: 1 / 2;
            background-color: #111111;
            border-right: 1px solid #1f1f1f;
            padding: 20px;
            overflow-y: auto;
        }

        .welcome-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #1f1f1f;
        }

        .welcome-text {
            color: #777;
            font-size: 12px;
        }

        .username {
            color: #e0e0e0;
            font-size: 16px;
            font-weight: 600;
            margin-top: 2px;
        }

        /* Recent Dates Section */
        .recent-dates-section {
            margin-bottom: 20px;
        }

        .section-header {
            color: #4ade80;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #1f1f1f;
        }

        .date-card {
            background-color: #1a1a1a;
            border: 1px solid #2a2a2a;
            padding: 12px;
            margin-bottom: 6px;
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease;
        }

        .date-card:hover {
            background-color: #252525;
            border-color: #444;
        }

        .date-card.active {
            background-color: #0a0a0a;
            border-color: #4ade80;
            box-shadow: 0 0 0 1px #4ade80;
        }

        .date-text {
            font-size: 11px;
            font-weight: 600;
            color: #e0e0e0;
        }

        .date-details {
            font-size: 9px;
            color: #777;
            margin-top: 2px;
        }

        .reanalyze-btn {
            position: absolute;
            right: 6px;
            top: 50%;
            transform: translateY(-50%);
            background-color: transparent;
            border: none;
            color: #777;
            cursor: pointer;
            font-size: 11px;
            padding: 2px;
            transition: all 0.2s ease;
        }

        .reanalyze-btn:hover {
            color: #e0e0e0;
            background-color: #2a2a2a;
        }

        /* Custom Date Section */
        .custom-date-section {
            margin-bottom: 20px;
        }

        .date-picker-container {
            background-color: #1a1a1a;
            border: 1px solid #2a2a2a;
            padding: 12px;
            margin-bottom: 10px;
        }

        .date-picker-label {
            color: #fb923c;
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 8px;
            display: block;
        }

        .date-input {
            width: 100%;
            background-color: #0f0f0f;
            border: 1px solid #2a2a2a;
            color: #e0e0e0;
            padding: 8px;
            font-family: 'Fira Code', monospace;
            font-size: 11px;
            margin-bottom: 8px;
        }

        .date-input:focus {
            outline: none;
            border-color: #fb923c;
        }

        .date-input::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }

        .load-date-btn {
            width: 100%;
            background-color: #fb923c;
            color: #0f0f0f;
            border: none;
            padding: 8px;
            font-family: 'Fira Code', monospace;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 8px;
            transition: background-color 0.2s ease;
        }

        .load-date-btn:hover {
            background-color: #f97316;
        }

        .load-date-btn:disabled {
            background-color: #2a2a2a;
            color: #777;
            cursor: not-allowed;
        }

        /* Selected Custom Date Display */
        .selected-date-container {
            background-color: #0f0f0f;
            border: 1px solid #2a2a2a;
            padding: 10px;
            display: none;
        }

        .selected-date-container.show {
            display: block;
        }

        .selected-date-label {
            color: #777;
            font-size: 9px;
            margin-bottom: 4px;
        }

        .selected-date-display {
            background-color: #2a2a2a;
            border: 1px solid #444;
            padding: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .selected-date-display:hover {
            background-color: #444;
        }

        .selected-date-display.active {
            background-color: #0a0a0a;
            border-color: #fb923c;
            box-shadow: 0 0 0 1px #fb923c;
        }

        .selected-date-text {
            color: #e0e0e0;
            font-size: 11px;
            font-weight: 600;
        }

        .selected-date-subtitle {
            color: #777;
            font-size: 9px;
            margin-top: 2px;
        }

        .custom-reanalyze-btn {
            position: absolute;
            right: 6px;
            top: 50%;
            transform: translateY(-50%);
            background-color: transparent;
            border: none;
            color: #777;
            cursor: pointer;
            font-size: 11px;
            padding: 2px;
            transition: all 0.2s ease;
        }

        .custom-reanalyze-btn:hover {
            color: #e0e0e0;
            background-color: #fb923c;
        }

        /* Main Content Area */
        .main-content {
            grid-column: 2 / 6;
            background-color: #131313;
            border-right: 1px solid #1f1f1f;
            padding: 20px;
            overflow-y: auto;
            position: relative;
        }

        /* Watermark */
        .main-content::before {
            content: 'MSAS VPL ANALYZER';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-25deg);
            font-family: 'Fira Code', monospace;
            font-size: 42px;
            font-weight: 700;
            color: #ffffff;
            opacity: 0.015;
            z-index: 0;
            pointer-events: none;
            white-space: nowrap;
            letter-spacing: 6px;
        }

        .main-content > * {
            position: relative;
            z-index: 1;
        }

        .content-title {
            font-size: 16px;
            font-weight: 600;
            color: #e0e0e0;
            margin-bottom: 20px;
            border-bottom: 1px solid #1f1f1f;
            padding-bottom: 10px;
        }

        .changes-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .change-item {
            background-color: #1a1a1a;
            border: 1px solid #2a2a2a;
            padding: 15px;
            position: relative;
            transition: background-color 0.2s ease;
        }

        .change-item:hover {
            background-color: #252525;
        }

        .change-item.added {
            border-left: 3px solid #4ade80;
        }

        .change-item.removed {
            border-left: 3px solid #f87171;
        }

        .change-item.modified {
            border-left: 3px solid #fb923c;
        }

        .change-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .change-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .part-transition {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }

        .old-part {
            background-color: #991b1b;
            color: #fecaca;
            padding: 4px 8px;
            font-size: 11px;
            border-radius: 2px;
        }

        .new-part {
            background-color: #166534;
            color: #bbf7d0;
            padding: 4px 8px;
            font-size: 11px;
            border-radius: 2px;
        }

        .arrow {
            color: #777;
            font-size: 12px;
        }

        .change-badge {
            font-size: 10px;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 3px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .change-badge.added {
            background-color: #166534;
            color: #bbf7d0;
        }

        .change-badge.removed {
            background-color: #991b1b;
            color: #fecaca;
        }

        .change-badge.prefix-changed {
            background-color: #581c87;
            color: #e9d5ff;
        }

        .change-badge.base-changed {
            background-color: #9a3412;
            color: #fed7aa;
        }

        .change-badge.suffix-changed {
            background-color: #1e40af;
            color: #bfdbfe;
        }

        .change-badge.modified {
            background-color: #374151;
            color: #e5e7eb;
        }

        .affected-count {
            color: #777;
            font-size: 11px;
        }

        .details-btn {
            background-color: #2a2a2a;
            color: #e0e0e0;
            border: 1px solid #444;
            padding: 6px 12px;
            font-size: 10px;
            font-family: 'Fira Code', monospace;
            cursor: pointer;
            white-space: nowrap;
            transition: background-color 0.2s ease;
        }

        .details-btn:hover {
            background-color: #444;
        }

        /* Right Sidebar */
        .right-sidebar {
            grid-column: 6 / 7;
            background-color: #111111;
            padding: 20px;
            overflow-y: auto;
            position: relative;
        }

        .right-sidebar::before {
            content: 'MSAS';
            position: absolute;
            top: 30%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(15deg);
            font-family: 'Fira Code', monospace;
            font-size: 24px;
            font-weight: 600;
            color: #ffffff;
            opacity: 0.02;
            z-index: 0;
            pointer-events: none;
        }

        .right-sidebar > * {
            position: relative;
            z-index: 1;
        }

        .missing-parts-section {
            padding-top: 60px;
        }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: #f87171;
            margin-bottom: 15px;
            border-bottom: 1px solid #1f1f1f;
            padding-bottom: 8px;
        }

        .missing-item {
            background-color: #1a1a1a;
            border-left: 3px solid #f87171;
            padding: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            position: relative;
            transition: background-color 0.2s ease;
        }

        .missing-item:hover {
            background-color: #252525;
        }

        .missing-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .missing-info {
            flex: 1;
        }

        .missing-part {
            font-weight: 600;
            color: #f87171;
            font-size: 12px;
        }

        .missing-count {
            font-size: 10px;
            color: #777;
            margin-top: 2px;
        }

        .missing-details-btn {
            background-color: #2a2a2a;
            color: #e0e0e0;
            border: 1px solid #444;
            padding: 4px 8px;
            font-size: 9px;
            font-family: 'Fira Code', monospace;
            cursor: pointer;
            white-space: nowrap;
            transition: background-color 0.2s ease;
        }

        .missing-details-btn:hover {
            background-color: #444;
        }

        /* States */
        .loading {
            text-align: center;
            padding: 40px;
            color: #777;
            font-size: 12px;
        }

        .loading .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #2a2a2a;
            border-top: 2px solid #4ade80;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #777;
        }

        .empty-state h3 {
            font-size: 14px;
            margin-bottom: 8px;
            color: #999;
        }

        .empty-state p {
            font-size: 11px;
            line-height: 1.4;
        }

        .error-state {
            text-align: center;
            padding: 40px 20px;
            color: #f87171;
        }

        .error-state h3 {
            font-size: 14px;
            margin-bottom: 8px;
        }

        .error-state p {
            font-size: 11px;
            line-height: 1.4;
        }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
        }

        .modal-overlay.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: #1a1a1a;
            border: 1px solid #2a2a2a;
            width: 90%;
            max-width: 1000px;
            height: 80%;
            max-height: 700px;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            background-color: #151515;
            border-bottom: 1px solid #2a2a2a;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            color: #e0e0e0;
            font-size: 16px;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            color: #777;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            transition: color 0.2s ease;
        }

        .close-btn:hover {
            color: #e0e0e0;
        }

        .modal-filters {
            background-color: #0f0f0f;
            border-bottom: 1px solid #2a2a2a;
            padding: 15px 20px;
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .filter-input {
            flex: 1;
            padding: 8px 12px;
            background-color: #2a2a2a;
            border: 1px solid #444;
            color: #e0e0e0;
            font-family: 'Fira Code', monospace;
            font-size: 12px;
        }

        .filter-input:focus {
            outline: none;
            border-color: #666;
        }

        .modal-body {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .modal-footer {
            background-color: #0f0f0f;
            border-top: 1px solid #2a2a2a;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .export-btn {
            background-color: #2a2a2a;
            border: 1px solid #444;
            color: #e0e0e0;
            padding: 8px 16px;
            font-size: 12px;
            font-family: 'Fira Code', monospace;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .export-btn:hover {
            background-color: #444;
        }

        .vin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 8px;
        }

        .vin-tag {
            background-color: #252525;
            border: 1px solid #333;
            padding: 8px 10px;
            font-size: 11px;
            color: #e0e0e0;
            text-align: center;
            font-weight: 500;
            transition: background-color 0.2s ease;
        }

        .vin-tag:hover {
            background-color: #2f2f2f;
        }

        .results-count {
            color: #777;
            font-size: 11px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #2a2a2a;
        }
        /* Scroll bar colors - VPL Dashboard */
::-webkit-scrollbar {
    width: 12px;
    height: 12px;
}

::-webkit-scrollbar-track {
    background: #0a0a0a;
}

::-webkit-scrollbar-thumb {
    background: #2a2a2a;
    border-radius: 6px;
}

::-webkit-scrollbar-thumb:hover {
    background: #444;
}

::-webkit-scrollbar-corner {
    background: #0a0a0a;
}

html {
    scrollbar-width: thin;
    scrollbar-color: #2a2a2a #0a0a0a;
}

.main-content::-webkit-scrollbar-track,
.sidebar::-webkit-scrollbar-track,
.right-sidebar::-webkit-scrollbar-track,
.modal-body::-webkit-scrollbar-track {
    background: #0a0a0a;
}

/* Animations */

        /* Animations */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .change-item {
            animation: fadeIn 0.3s ease-out;
        }

        /* Spinning animation for reanalyze buttons */
        .spinning {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body>
    <!-- Header Area -->
    <div class="header-area">
        <div class="header-left">
            <h1>MSAS VPL Analyzer</h1>
        </div>
        <div class="header-buttons">
            <button class="header-btn" onclick="App.goBackToSelection()">‚Üê Dashboard Selection</button>
            <button class="header-btn" onclick="App.openConfig()">Config</button>
            <button class="header-btn" id="manualAnalysisBtn" onclick="App.triggerManualAnalysis()">Manuel Analiz</button>
        </div>
    </div>

    <!-- Left Sidebar -->
    <div class="sidebar">
        <div class="welcome-section">
            <div class="welcome-text">Welcome,</div>
            <div class="username">Admin</div>
        </div>
        
        <!-- Recent Dates Section -->
        <div class="recent-dates-section">
            <div class="section-header">üìÖ Son 4 G√ºn</div>
            <div id="dateCards"></div>
        </div>

        <!-- Custom Date Picker Section -->
        <div class="custom-date-section">
            <div class="section-header">üóìÔ∏è √ñzel Tarih Se√ß</div>
            <div class="date-picker-container">
                <label class="date-picker-label" for="customDate">Analiz Tarihi:</label>
                <input type="date" id="customDate" class="date-input">
                <button class="load-date-btn" id="loadDateBtn" onclick="App.loadCustomDate()">
                    üìä Analizi Y√ºkle
                </button>
            </div>
            
            <div class="selected-date-container" id="selectedDateContainer">
                <div class="selected-date-label">Se√ßili √ñzel Tarih:</div>
                <div class="selected-date-display" id="selectedDateDisplay" onclick="App.loadSelectedCustomDate()">
                    <div class="selected-date-text" id="selectedDateText"></div>
                    <div class="selected-date-subtitle">Analiz i√ßin tƒ±klayƒ±n</div>
                    <button class="custom-reanalyze-btn" onclick="event.stopPropagation(); App.reanalyzeCustomDate()">‚Üª</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="main-content">
        <div class="content-title" id="analysisTitle">
            MSAS VPL Analyzer - Ho≈ü Geldiniz
        </div>
        
        <div class="changes-container" id="changesContainer">
            <div class="loading">
                <div class="spinner"></div>
                En son analiz verisi aranƒ±yor...
            </div>
        </div>
    </div>

    <!-- Right Sidebar -->
    <div class="right-sidebar">
        <div class="missing-parts-section">
            <div class="section-title">
                Eksik Required Parts
            </div>
            
            <div id="missingPartsContainer">
                <div class="loading">
                    <div class="spinner"></div>
                    Analiz verisi y√ºkleniyor...
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Overlay -->
    <div class="modal-overlay" id="detailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Detaylar</h3>
                <button class="close-btn" onclick="ModalComponent.hide()">‚úï</button>
            </div>
            <div class="modal-filters">
                <input type="text" class="filter-input" id="searchInput" placeholder="üîç VIN ara (√∂rn: ABC)...">
            </div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-footer">
                <div class="results-count" id="resultsCount">Toplam: 0 sonu√ß</div>
                <button class="export-btn" onclick="ModalComponent.exportData()">üì• CSV Export</button>
            </div>
        </div>
    </div>

    <script>
        // ===============================================================================
        // 1. UTILS & HELPERS MODULE
        // ===============================================================================

        const DateUtils = {
            formatTurkish(date) {
                const months = [
                    'Ocak', '≈ûubat', 'Mart', 'Nisan', 'Mayƒ±s', 'Haziran',
                    'Temmuz', 'Aƒüustos', 'Eyl√ºl', 'Ekim', 'Kasƒ±m', 'Aralƒ±k'
                ];
                
                const day = date.getDate();
                const month = months[date.getMonth()];
                const year = date.getFullYear();
                
                return `${day} ${month} ${year}`;
            },

            formatISO(date) {
                const isoString = date.toISOString().split('T')[0];
                console.log(`üìÖ formatISO: ${date.toDateString()} ‚Üí ${isoString}`);
                return isoString;
            },

            getDateRange(days) {
                const dates = [];
                const today = new Date();
                
                for (let i = 0; i < days; i++) {
                    const date = new Date(today);
                    date.setDate(today.getDate() - i);
                    dates.push(date);
                }
                
                return dates;
            },

            isValidDate(dateStr) {
                const date = new Date(dateStr);
                return date instanceof Date && !isNaN(date);
            }
        };

        const Validators = {
            isValidAnalysis(data) {
                return data && typeof data === 'object' && 
                       (Array.isArray(data.part_changes) || Array.isArray(data.missing_required_file2));
            },

            isValidPartChange(change) {
                return change && typeof change === 'object' && 
                       change.change_type && 
                       typeof change.affected_count === 'number' &&
                       Array.isArray(change.affected_vins);
            },

            hasRealData(analysis) {
                // Check if this is real analysis data vs fake/empty data
                if (!analysis) return false;
                
                const hasPartChanges = analysis.part_changes && analysis.part_changes.length > 0;
                const hasMissingParts = analysis.missing_required_file2 && analysis.missing_required_file2.length > 0;
                
                return hasPartChanges || hasMissingParts;
            },

            sanitizeInput(input) {
                if (typeof input !== 'string') return '';
                return input.trim().replace(/[<>]/g, '');
            }
        };

        const DOMUtils = {
            createElement(tag, className = '', content = '') {
                const element = document.createElement(tag);
                if (className) element.className = className;
                if (content) element.innerHTML = content;
                return element;
            },

            clearElement(selector) {
                const element = document.querySelector(selector);
                if (element) element.innerHTML = '';
                return element;
            },

            showElement(selector) {
                const element = document.querySelector(selector);
                if (element) element.style.display = 'block';
                return element;
            },

            hideElement(selector) {
                const element = document.querySelector(selector);
                if (element) element.style.display = 'none';
                return element;
            }
        };

        // ===============================================================================
        // 2. STATE MANAGEMENT MODULE
        // ===============================================================================

        const AppState = {
            data: {
                currentDate: null,
                analysisData: null,
                selectedCustomDate: null,
                loading: false,
                error: null
            },

            observers: new Map(),

            // Setters
            setCurrentDate(date) {
                this.data.currentDate = date;
                this.notify('currentDate', date);
            },

            setAnalysisData(data) {
                this.data.analysisData = data;
                this.notify('analysisData', data);
            },

            setSelectedCustomDate(date) {
                this.data.selectedCustomDate = date;
                this.notify('selectedCustomDate', date);
            },

            setLoading(status) {
                this.data.loading = status;
                this.notify('loading', status);
            },

            setError(error) {
                this.data.error = error;
                this.notify('error', error);
            },

            clearState() {
                this.data = {
                    currentDate: null,
                    analysisData: null,
                    selectedCustomDate: null,
                    loading: false,
                    error: null
                };
                this.notify('stateCleared', true);
            },

            // Getters
            getCurrentAnalysis() {
                return this.data.analysisData;
            },
            

            getCurrentDate() {
                return this.data.currentDate;
            },

            getSelectedCustomDate() {
                return this.data.selectedCustomDate;
            },

            isLoading() {
                return this.data.loading;
            },

            hasError() {
                return this.data.error !== null;
            },

            getError() {
                return this.data.error;
            },

            // Observer Pattern
            subscribe(key, callback) {
                if (!this.observers.has(key)) {
                    this.observers.set(key, []);
                }
                this.observers.get(key).push(callback);
            },

            unsubscribe(key, callback) {
                if (this.observers.has(key)) {
                    const callbacks = this.observers.get(key);
                    const index = callbacks.indexOf(callback);
                    if (index > -1) {
                        callbacks.splice(index, 1);
                    }
                }
            },

            notify(key, data) {
                if (this.observers.has(key)) {
                    this.observers.get(key).forEach(callback => {
                        try {
                            callback(data);
                        } catch (error) {
                            console.error('Observer callback error:', error);
                        }
                    });
                }
            }
        };

        // ===============================================================================
        // 3. API LAYER MODULE
        // ===============================================================================

        const APIClient = {
            baseURL: '/api',
async triggerManualAnalysis() {
    console.log('üî® Triggering manual analysis...');
    
    const button = document.getElementById('manualAnalysisBtn');
    if (button) {
        const originalText = button.textContent;
        button.textContent = 'Analiz Yapƒ±lƒ±yor...';
        button.disabled = true;
        
        // ‚úÖ Loading state - kullanƒ±cƒ±ya net bilgi ver
        LoadingComponent.show('#changesContainer', 
            'Manuel analiz ba≈ülatƒ±ldƒ±...\n\n' +
            '1. Eski veriler temizleniyor\n' + 
            '2. VPL dosyasƒ± okunuyor\n' +
            '3. Kar≈üƒ±la≈ütƒ±rma yapƒ±lƒ±yor\n' +
            '4. Sonu√ßlar kaydediliyor\n\n' +
            'L√ºtfen bekleyin, i≈ülem tamamlanana kadar sayfa deƒüi≈ütirmeyiniz.'
        );
        LoadingComponent.show('#missingPartsContainer', 'Analiz devam ediyor...');
        
        try {
            // ‚úÖ Backend sync olarak √ßalƒ±≈üacak, bekleme gerekli
            const response = await APIClient.triggerManualAnalysis();
            
            if (response.success) {
                console.log('‚úÖ Manual analysis completed:', response.message);
                
                // ‚úÖ Analiz bitti, yeni veriyi y√ºkle
                const today = DateUtils.formatISO(new Date());
                console.log('üîÑ Loading fresh analysis data for:', today);
                
                // Kƒ±sa bir delay sonra yeni veriyi y√ºkle (cache temizlemek i√ßin)
                setTimeout(() => {
                    this.loadAnalysisForDate(today);
                }, 500);
                
            } else {
                throw new Error(response.message || 'Manual analysis failed');
            }
        } catch (error) {
            console.error('‚ùå Manual analysis error:', error);
            
            if (error.message.includes('Failed to clear')) {
                ErrorComponent.show('#changesContainer', 
                    'Veritabanƒ± temizleme hatasƒ±: ' + error.message + 
                    '\n\nL√ºtfen tekrar deneyin.');
            } else if (error.message.includes('Analysis failed')) {
                ErrorComponent.show('#changesContainer', 
                    'Analiz hatasƒ±: ' + error.message +
                    '\n\nDosyalarƒ±n mevcut olduƒüundan emin olun.');
            } else {
                ErrorComponent.show('#changesContainer', 
                    'Manuel analiz sƒ±rasƒ±nda bir hata olu≈ütu: ' + error.message);
            }
        } finally {
            button.textContent = originalText;
            button.disabled = false;
        }
    }
},

            async fetchAnalysis(date) {
                console.log('üì° Fetching analysis for date:', date);
                
                try {
                    const response = await fetch(`${this.baseURL}/analysis/${date}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    console.log('üì• API Response:', data);
                    
                    return data;
                } catch (error) {
                    console.error('‚ùå API Error:', error);
                    throw error;
                }
            },

            async triggerManualAnalysis() {
                console.log('üî® Triggering manual analysis');
                
                try {
                    const response = await fetch(`${this.baseURL}/vpl/analyze`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    console.log('üì• Manual analysis response:', data);
                    
                    return data;
                } catch (error) {
                    console.error('‚ùå Manual analysis error:', error);
                    throw error;
                }
            },

            async reanalyzeDate(date) {
                console.log('üîÑ Reanalyzing date:', date);
                
                try {
                    const response = await fetch(`${this.baseURL}/reanalyze`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ date })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    console.log('üì• Reanalyze response:', data);
                    
                    return data;
                } catch (error) {
                    console.error('‚ùå Reanalyze error:', error);
                    throw error;
                }
            }
        };

        const ResponseNormalizer = {
            normalizeAnalysis(rawResponse) {
                console.log('üîÑ Normalizing response:', rawResponse);
                
                if (!rawResponse.success || !rawResponse.data) {
                    throw new Error('Invalid response format');
                }
                
                const analysisData = rawResponse.data.analysis || rawResponse.data;
                
                return {
                    partChanges: this.normalizePartChanges(analysisData.part_changes || []),
                    missingRequired: this.normalizeMissingRequired(analysisData.missing_required_file2 || []),
                    summary: analysisData.summary || {}
                };
            },

            normalizePartChanges(changes) {
                if (!Array.isArray(changes)) return [];
                
                return changes.map(change => ({
                    type: change.change_type || 'UNKNOWN',
                    oldPart: change.old_part || change.old_part_name || '',
                    newPart: change.new_part || change.new_part_name || '',
                    detail: change.change_detail || '',
                    affectedCount: change.affected_count || 0,
                    affectedVins: change.affected_vins || []
                }));
            },

            normalizeMissingRequired(missing) {
                console.log('üîÑ Normalizing missing required:', missing);
                console.log('üîÑ Missing type:', typeof missing);
                console.log('üîÑ Missing is array:', Array.isArray(missing));
                
                if (!Array.isArray(missing)) {
                    console.log('‚ùå Missing is not an array:', missing);
                    return [];
                }
                
                const normalized = missing.map((item, index) => {
                    console.log(`üîÑ Processing missing ${index}:`, item);
                    console.log(`üîÑ Missing keys:`, Object.keys(item));
                    
                    const result = {
                        requiredBase: item.required_base || '',
                        missingCount: item.missing_count || 0,
                        missingVins: item.missing_vins || []
                    };
                    
                    console.log(`‚úÖ Normalized missing ${index}:`, result);
                    return result;
                });
                
                console.log('‚úÖ All normalized missing required:', normalized.length);
                return normalized;
            }
        };

        // ===============================================================================
        // 4. UI COMPONENTS MODULE
        // ===============================================================================

        const LoadingComponent = {
            show(container, message = 'Loading...') {
                const element = typeof container === 'string' ? 
                    document.querySelector(container) : container;
                
                if (element) {
                    element.innerHTML = `
                        <div class="loading">
                            <div class="spinner"></div>
                            ${message}
                        </div>
                    `;
                }
            },

            hide(container) {
                const element = typeof container === 'string' ? 
                    document.querySelector(container) : container;
                
                if (element) {
                    const loading = element.querySelector('.loading');
                    if (loading) {
                        loading.remove();
                    }
                }
            },

            showWithProgress(container, progress, message = 'Loading...') {
                const element = typeof container === 'string' ? 
                    document.querySelector(container) : container;
                
                if (element) {
                    element.innerHTML = `
                        <div class="loading">
                            <div class="spinner"></div>
                            ${message} (${progress}%)
                        </div>
                    `;
                }
            }
        };

        const ErrorComponent = {
            show(container, message, type = 'error') {
                const element = typeof container === 'string' ? 
                    document.querySelector(container) : container;
                
                if (element) {
                    element.innerHTML = `
                        <div class="error-state">
                            <h3>‚ö†Ô∏è ${type === 'error' ? 'Hata Olu≈ütu' : 'Bilgi'}</h3>
                            <p>${message}</p>
                        </div>
                    `;
                }
            },

            showEmpty(container, title, message) {
                const element = typeof container === 'string' ? 
                    document.querySelector(container) : container;
                
                if (element) {
                    element.innerHTML = `
                        <div class="empty-state">
                            <h3>${title}</h3>
                            <p>${message}</p>
                        </div>
                    `;
                }
            },

            showNoData(container) {
                this.showEmpty(container, 
                    'MSAS VPL Analyzer, bir MSAS √ºr√ºn√ºd√ºr.',
                    'Talep ve √∂neriler i√ßin: <a href="mailto:alpaslanbugra0@gmail.com">alpaslanbugra0@gmail.com'
                );
            }
        };

        const PartChangesComponent = {
            render(container, partChanges) {
                console.log('üé® Rendering part changes:', partChanges.length);
                
                const element = typeof container === 'string' ? 
                    document.querySelector(container) : container;
                
                if (!element) return;
                
                if (!partChanges || partChanges.length === 0) {
                    ErrorComponent.showEmpty(element,
                        'üéâ Hi√ßbir par√ßa deƒüi≈üikliƒüi bulunamadƒ±',
                        'Bu tarih aralƒ±ƒüƒ±nda herhangi bir par√ßa deƒüi≈üikliƒüi tespit edilmedi.'
                    );
                    return;
                }

                const changesHtml = partChanges.map((change, index) => 
                    this.renderChangeItem(change, index)
                ).join('');

                element.innerHTML = changesHtml;
            },

            renderChangeItem(change, index) {
                const changeClass = this.getChangeClass(change.type);
                const partTransition = this.renderPartTransition(change);
                const changeBadge = this.renderChangeBadge(change);
                
                return `
                    <div class="change-item ${changeClass}" data-change-type="${change.type}">
                        <div class="change-header">
                            <div class="change-info">
                                ${partTransition}
                                ${changeBadge}
                                <span class="affected-count">${change.affectedCount} VIN etkilendi</span>
                            </div>
                            <button class="details-btn" onclick="EventHandler.onPartChangeClick(${index}); event.stopPropagation();">
                                Detaylarƒ± G√∂r
                            </button>
                        </div>
                    </div>
                `;
            },

            getChangeClass(type) {
                switch(type) {
                    case 'PART_ADDED':
                        return 'added';
                    case 'PART_REMOVED':
                        return 'removed';
                    case 'PREFIX_CHANGED':
                    case 'BASE_CHANGED':
                    case 'SUFFIX_CHANGED':
                    case 'PART_CHANGED':
                        return 'modified';
                    default:
                        return 'modified';
                }
            },

            renderPartTransition(change) {
                if (change.type === 'PART_ADDED') {
                    return `
                        <div class="part-transition">
                            <span class="new-part">${change.newPart}</span>
                        </div>
                    `;
                } else if (change.type === 'PART_REMOVED') {
                    return `
                        <div class="part-transition">
                            <span class="old-part">${change.oldPart}</span>
                        </div>
                    `;
                } else {
                    return `
                        <div class="part-transition">
                            <span class="old-part">${change.oldPart}</span>
                            <span class="arrow">‚Üí</span>
                            <span class="new-part">${change.newPart}</span>
                        </div>
                    `;
                }
            },

            renderChangeBadge(change) {
                let displayType = '';
                let badgeClass = 'modified';
                
                switch(change.type) {
                    case 'PREFIX_CHANGED':
                        displayType = 'PREFIX CHANGE';
                        badgeClass = 'prefix-changed';
                        break;
                    case 'BASE_CHANGED':
                        displayType = 'BASE CHANGE';
                        badgeClass = 'base-changed';
                        break;
                    case 'SUFFIX_CHANGED':
                        displayType = 'SUFFIX CHANGE';
                        badgeClass = 'suffix-changed';
                        break;
                    case 'PART_ADDED':
                        displayType = 'PART ADDED';
                        badgeClass = 'added';
                        break;
                    case 'PART_REMOVED':
                        displayType = 'PART REMOVED';
                        badgeClass = 'removed';
                        break;
                    case 'PART_CHANGED':
                        displayType = 'PART CHANGE';
                        badgeClass = 'modified';
                        break;
                    default:
                        displayType = change.type;
                        badgeClass = 'modified';
                }
                
                return `<span class="change-badge ${badgeClass}">${displayType}</span>`;
            }
        };

        const MissingPartsComponent = {
            render(container, missingParts) {
                console.log('üé® Rendering missing parts:', missingParts.length);
                
                const element = typeof container === 'string' ? 
                    document.querySelector(container) : container;
                
                if (!element) return;
                
                if (!missingParts || missingParts.length === 0) {
                    ErrorComponent.showEmpty(element,
                        '‚úÖ T√ºm required parts mevcut',
                        'Hi√ßbir required part eksik bulunmadƒ±.'
                    );
                    return;
                }

                const missingHtml = missingParts.map((missing, index) => 
                    this.renderMissingItem(missing, index)
                ).join('');

                element.innerHTML = missingHtml;
            },

            renderMissingItem(missing, index) {
                return `
                    <div class="missing-item">
                        <div class="missing-header">
                            <div class="missing-info">
                                <div class="missing-part">${missing.requiredBase}</div>
                                <div class="missing-count">${missing.missingCount} VIN'de bulunamadƒ±</div>
                            </div>
                            <button class="missing-details-btn" onclick="EventHandler.onMissingPartClick(${index}); event.stopPropagation();">
                                Detaylarƒ± G√∂r
                            </button>
                        </div>
                    </div>
                `;
            }
        };

        const DatePickerComponent = {
            renderDateCards(container) {
                const element = typeof container === 'string' ? 
                    document.querySelector(container) : container;
                
                if (!element) return;
                
                const dates = DateUtils.getDateRange(4); // Last 4 days
                
                const cardsHtml = dates.map(date => {
                    const dateStr = DateUtils.formatISO(date);
                    const displayDate = DateUtils.formatTurkish(date);
                    
                    const previousDate = new Date(date);
                    previousDate.setDate(date.getDate() - 1);
                    const previousDisplayDate = DateUtils.formatTurkish(previousDate);
                    
                    return `
                        <div class="date-card" data-date="${dateStr}" onclick="EventHandler.onDateCardClick('${dateStr}')">
                            <div class="date-text">${displayDate}</div>
                            <div class="date-details">vs ${previousDisplayDate}</div>
                            <button class="reanalyze-btn" onclick="event.stopPropagation(); EventHandler.onReanalyzeClick('${dateStr}')">‚Üª</button>
                        </div>
                    `;
                }).join('');
                
                element.innerHTML = cardsHtml;
            },

            setActiveDate(date) {
                // Remove active from all cards
                document.querySelectorAll('.date-card').forEach(card => {
                    card.classList.remove('active');
                });
                
                // Set active on matching card
                const targetCard = document.querySelector(`[data-date="${date}"]`);
                if (targetCard) {
                    targetCard.classList.add('active');
                }
            },

            setupCustomDatePicker() {
                const dateInput = document.getElementById('customDate');
                if (dateInput) {
                    const today = new Date().toISOString().split('T')[0];
                    dateInput.max = today;
                }
            },

            showSelectedCustomDate(date) {
                const container = document.getElementById('selectedDateContainer');
                const textElement = document.getElementById('selectedDateText');
                
                if (container && textElement) {
                    const displayDate = DateUtils.formatTurkish(new Date(date));
                    textElement.textContent = displayDate;
                    container.classList.add('show');
                }
            },

            hideSelectedCustomDate() {
                const container = document.getElementById('selectedDateContainer');
                if (container) {
                    container.classList.remove('show');
                }
            },

            setActiveCustomDate(active = true) {
                const display = document.getElementById('selectedDateDisplay');
                if (display) {
                    if (active) {
                        display.classList.add('active');
                    } else {
                        display.classList.remove('active');
                    }
                }
            }
        };

        const ModalComponent = {
            currentData: null,

            show(title, content, options = {}) {
                const modal = document.getElementById('detailModal');
                const modalTitle = document.getElementById('modalTitle');
                const modalBody = document.getElementById('modalBody');
                const searchInput = document.getElementById('searchInput');
                
                if (modal && modalTitle && modalBody) {
                    modalTitle.textContent = title;
                    modalBody.innerHTML = content;
                    
                    // Setup search
                    if (searchInput) {
                        searchInput.value = '';
                        searchInput.placeholder = options.searchPlaceholder || 'üîç Ara...';
                        searchInput.oninput = () => this.handleSearch(searchInput.value);
                    }
                    
                    modal.classList.add('show');
                }
            },

            hide() {
                const modal = document.getElementById('detailModal');
                if (modal) {
                    modal.classList.remove('show');
                }
                this.currentData = null;
            },

            renderPartChangeModal(change) {
                let titleText = '';
                
                if (change.type === 'PART_ADDED') {
                    titleText = `ADDED: ${change.newPart} (${change.affectedCount} VIN)`;
                } else if (change.type === 'PART_REMOVED') {
                    titleText = `REMOVED: ${change.oldPart} (${change.affectedCount} VIN)`;
                } else if (change.type === 'PREFIX_CHANGED') {
                    titleText = `PREFIX Change: ${change.oldPart} ‚Üí ${change.newPart} (${change.affectedCount} VIN)`;
                } else if (change.type === 'BASE_CHANGED') {
                    titleText = `BASE Change: ${change.oldPart} ‚Üí ${change.newPart} (${change.affectedCount} VIN)`;
                } else if (change.type === 'SUFFIX_CHANGED') {
                    titleText = `SUFFIX Change: ${change.oldPart} ‚Üí ${change.newPart} (${change.affectedCount} VIN)`;
                } else {
                    titleText = `${change.oldPart} ‚Üí ${change.newPart} (${change.affectedCount} VIN)`;
                }

                this.currentData = {
                    type: 'partChanges',
                    data: change.affectedVins
                };

                const content = this.renderVinList(change.affectedVins);
                this.show(titleText, content, { 
                    searchPlaceholder: 'üîç VIN ara (√∂rn: ABC)...' 
                });
            },

            renderMissingPartModal(missing) {
                const titleText = `Eksik Part: ${missing.requiredBase} (${missing.missingCount} VIN)`;
                
                this.currentData = {
                    type: 'missingParts',
                    data: missing.missingVins
                };

                const content = this.renderVinList(missing.missingVins);
                this.show(titleText, content, { 
                    searchPlaceholder: 'üîç VIN ara (√∂rn: ABC)...' 
                });
            },

            renderVinList(vins) {
                if (!vins || vins.length === 0) {
                    return '<div class="error-state"><h3>Sonu√ß bulunamadƒ±</h3></div>';
                }
                
                const resultsCount = document.getElementById('resultsCount');
                if (resultsCount) {
                    resultsCount.textContent = `Toplam: ${vins.length} sonu√ß`;
                }
                
                const vinsHtml = vins.map(vin => `
                    <div class="vin-tag">${vin}</div>
                `).join('');
                
                return `<div class="vin-grid">${vinsHtml}</div>`;
            },

            handleSearch(searchTerm) {
                if (!this.currentData) return;
                
                const originalData = this.currentData.data;
                let filteredData = originalData;
                
                if (searchTerm.trim()) {
                    filteredData = originalData.filter(vin => 
                        vin.toLowerCase().startsWith(searchTerm.toLowerCase())
                    );
                }
                
                const modalBody = document.getElementById('modalBody');
                if (modalBody) {
                    modalBody.innerHTML = this.renderVinList(filteredData);
                }
            },

            exportData() {
                if (!this.currentData) return;
                
                const searchInput = document.getElementById('searchInput');
                const searchTerm = searchInput ? searchInput.value.trim() : '';
                
                let exportData = this.currentData.data;
                if (searchTerm) {
                    exportData = this.currentData.data.filter(vin => 
                        vin.toLowerCase().startsWith(searchTerm.toLowerCase())
                    );
                }
                
                if (exportData.length === 0) {
                    alert('Export edilecek veri bulunamadƒ±');
                    return;
                }
                
                const csvContent = 'VIN\n' + exportData.join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', `vins_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        };

        // ===============================================================================
        // 5. EVENT HANDLER MODULE
        // ===============================================================================

        const EventHandler = {
            onDateCardClick(date) {
                console.log('üìÖ Date card clicked:', date);
                
                // Clear custom date selection if clicking recent dates
                const currentCustomDate = AppState.getSelectedCustomDate();
                if (currentCustomDate && currentCustomDate !== date) {
                    AppState.setSelectedCustomDate(null);
                    DatePickerComponent.hideSelectedCustomDate();
                    DatePickerComponent.setActiveCustomDate(false);
                }
                
                App.loadAnalysisForDate(date);
            },

            onCustomDateSelect(date) {
                console.log('üìÖ Custom date selected:', date);
                App.loadCustomDate();
            },

            onPartChangeClick(index) {
                console.log('üìä Part change clicked:', index);
                
                const analysis = AppState.getCurrentAnalysis();
                if (analysis && analysis.partChanges && analysis.partChanges[index]) {
                    ModalComponent.renderPartChangeModal(analysis.partChanges[index]);
                }
            },

            onMissingPartClick(index) {
                console.log('üìä Missing part clicked:', index);
                
                const analysis = AppState.getCurrentAnalysis();
                if (analysis && analysis.missingRequired && analysis.missingRequired[index]) {
                    ModalComponent.renderMissingPartModal(analysis.missingRequired[index]);
                }
            },

            onReanalyzeClick(date) {
                console.log('üîÑ Reanalyze clicked:', date);
                
                const button = event.target;
                const originalText = button.textContent;
                
                button.textContent = '‚ü≥';
                button.classList.add('spinning');
                
                APIClient.reanalyzeDate(date)
                    .then(data => {
                        if (data.success) {
                            // Reload analysis after reanalysis
                            setTimeout(() => {
                                App.loadAnalysisForDate(date);
                            }, 2000);
                        } else {
                            alert('Yeniden analiz ba≈üarƒ±sƒ±z: ' + (data.message || 'Bilinmeyen hata'));
                        }
                    })
                    .catch(error => {
                        console.error('Reanalyze error:', error);
                        alert('Yeniden analiz sƒ±rasƒ±nda bir hata olu≈ütu');
                    })
                    .finally(() => {
                        button.textContent = originalText;
                        button.classList.remove('spinning');
                    });
            },

            onManualAnalysisClick() {
                console.log('üî® Manual analysis clicked');
                App.triggerManualAnalysis();
            }
        };

        // ===============================================================================
        // 6. APP CONTROLLER MODULE
        // ===============================================================================

        const App = {
            async init() {
                console.log('üöÄ App initializing...');
                
                this.setupEventListeners();
                this.setupStateObservers();
                this.initializeUI();
                await this.loadInitialData();
                
                console.log('‚úÖ App initialized');
            },

            setupEventListeners() {
                // Modal close events
                document.getElementById('detailModal').addEventListener('click', (e) => {
                    if (e.target === e.currentTarget) {
                        ModalComponent.hide();
                    }
                });
                
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        ModalComponent.hide();
                    }
                });
            },

            setupStateObservers() {
                // Subscribe to state changes
                AppState.subscribe('analysisData', (data) => {
                    console.log('üìä Analysis data updated');
                    this.updateAnalysisDisplay(data);
                });

                AppState.subscribe('loading', (loading) => {
                    console.log('üîÑ Loading state changed:', loading);
                    this.updateLoadingState(loading);
                });

                AppState.subscribe('error', (error) => {
                    console.log('‚ùå Error state changed:', error);
                    this.updateErrorState(error);
                });

                AppState.subscribe('currentDate', (date) => {
                    console.log('üìÖ Current date changed:', date);
                    this.updateDateDisplay(date);
                });
            },

            initializeUI() {
                // Setup date picker
                DatePickerComponent.renderDateCards('#dateCards');
                DatePickerComponent.setupCustomDatePicker();
                
                // Set initial title
                document.getElementById('analysisTitle').textContent = 'MSAS VPL Analyzer - Ho≈ü Geldiniz';
            },

            async loadInitialData() {
                console.log('üîç Loading initial data...');
                
                // Show loading state
                LoadingComponent.show('#changesContainer', 'En son analiz verisi aranƒ±yor...');
                LoadingComponent.show('#missingPartsContainer', 'Analiz verisi y√ºkleniyor...');
                
                // Try to find analysis for recent dates
                await this.findLatestAnalysis();
            },

            async findLatestAnalysis() {
                const dates = DateUtils.getDateRange(7); // Try last 7 days
                
                for (const date of dates) {
                    try {
                        const dateStr = DateUtils.formatISO(date);
                        console.log(`üìÖ Trying date: ${dateStr}`);
                        
                        const response = await APIClient.fetchAnalysis(dateStr);
                        
                        if (response.success) {
                            console.log('‚úÖ Found analysis for:', dateStr);
                            const normalizedData = ResponseNormalizer.normalizeAnalysis(response);
                            
                            if (Validators.hasRealData(normalizedData)) {
                                AppState.setCurrentDate(dateStr);
                                AppState.setAnalysisData(normalizedData);
                                return; // Success - exit loop
                            }
                        }
                    } catch (error) {
                        console.log(`‚ùå No analysis for ${DateUtils.formatISO(date)}`);
                        continue; // Try next date
                    }
                }
                
                // No analysis found
                console.log('‚ùå No analysis found in last 7 days');
                ErrorComponent.showNoData('#changesContainer');
                ErrorComponent.showEmpty('#missingPartsContainer', 
                    ' ', 
                    ' '
                );
            },

            async loadAnalysisForDate(dateStr) {
                console.log('üîç Loading analysis for date:', dateStr);
                
                // Set loading state
                AppState.setLoading(true);
                AppState.setError(null);
                AppState.setCurrentDate(dateStr);
                
                try {
                    const response = await APIClient.fetchAnalysis(dateStr);
                    
                    console.log('üì• Raw API response:', response);
                    
                    if (response.success) {
                        const normalizedData = ResponseNormalizer.normalizeAnalysis(response);
                        
                        console.log('üîç Normalized data check:', normalizedData);
                        console.log('‚úÖ Setting analysis data');
                        
                        AppState.setAnalysisData(normalizedData);
                        console.log('‚úÖ Analysis loaded successfully');
                    } else {
                        throw new Error(response.message || 'Analysis request failed');
                    }
                } catch (error) {
                    console.error('‚ùå Analysis load error:', error);
                    AppState.setError(error.message);
                } finally {
                    AppState.setLoading(false);
                }
            },

            loadCustomDate() {
                const dateInput = document.getElementById('customDate');
                const selectedDate = dateInput ? dateInput.value : null;
                
                if (!selectedDate) {
                    alert('L√ºtfen bir tarih se√ßin');
                    return;
                }
                
                console.log('üìÖ Loading custom date:', selectedDate);
                
                // Update UI
                const loadBtn = document.getElementById('loadDateBtn');
                if (loadBtn) {
                    const originalText = loadBtn.textContent;
                    loadBtn.textContent = 'üîç Y√ºkleniyor...';
                    loadBtn.disabled = true;
                    
                    // Store custom date and show display
                    AppState.setSelectedCustomDate(selectedDate);
                    DatePickerComponent.showSelectedCustomDate(selectedDate);
                    
                    // Load analysis
                    this.loadAnalysisForDate(selectedDate).finally(() => {
                        loadBtn.textContent = originalText;
                        loadBtn.disabled = false;
                    });
                }
            },

            loadSelectedCustomDate() {
                const customDate = AppState.getSelectedCustomDate();
                if (customDate) {
                    this.loadAnalysisForDate(customDate);
                }
            },

            reanalyzeCustomDate() {
                const customDate = AppState.getSelectedCustomDate();
                if (customDate) {
                    EventHandler.onReanalyzeClick(customDate);
                }
            },

            async triggerManualAnalysis() {
    const button = document.getElementById('manualAnalysisBtn');
    const originalText = button.textContent;
    
    button.textContent = 'Analiz Ediliyor...';
    button.disabled = true;
    
    // Loading g√∂ster
    LoadingComponent.show('#changesContainer', 'Yeni analiz yapƒ±lƒ±yor...');
    
    try {
        await APIClient.triggerManualAnalysis();
        
        // Analiz bitene kadar bekle (polling)
        await this.waitForAnalysisCompletion();
        
        // Analiz bitti, yeni veriyi y√ºkle
        const today = DateUtils.formatISO(new Date());
        this.loadAnalysisForDate(today);
        
    } finally {
        button.textContent = originalText;
        button.disabled = false;
    }
},
async waitForAnalysisCompletion() {
    console.log('‚è≥ Polling for analysis completion...');
    
    const today = DateUtils.formatISO(new Date());
    let attempts = 0;
    const maxAttempts = 10; // Maximum 30 saniye bekle (3x10)
    
    while (attempts < maxAttempts) {
        attempts++;
        console.log(`üîç Checking analysis completion, attempt ${attempts}/${maxAttempts}`);
        
        try {
            // Yeni analiz sonucu var mƒ± kontrol et
            const response = await APIClient.fetchAnalysis(today);
            
            if (response.success && response.data) {
                const analysisData = ResponseNormalizer.normalizeAnalysis(response);
                
                // Eƒüer yeni veri geldi ise (issue sayƒ±sƒ± deƒüi≈üti vs), analiz tamamlanmƒ±≈ü demektir
                const currentAnalysis = AppState.getCurrentAnalysis();
                if (!currentAnalysis || 
                    JSON.stringify(analysisData) !== JSON.stringify(currentAnalysis)) {
                    console.log('‚úÖ New analysis data detected, analysis completed');
                    return true;
                }
            }
        } catch (error) {
            console.log(`‚ùå Polling attempt ${attempts} failed:`, error.message);
        }
        
        // 3 saniye bekle
        await new Promise(resolve => setTimeout(resolve, 3000));
    }
    
    console.log('‚è∞ Polling timeout, proceeding anyway');
    return false;
},
            openConfig() {
                window.location.href = '/config';
            },
            goBackToSelection() {
              window.location.href = '/selection';
            },


            // UI Update Methods
            updateAnalysisDisplay(analysisData) {
                if (!analysisData) {
                    ErrorComponent.showNoData('#changesContainer');
                    ErrorComponent.showEmpty('#missingPartsContainer', 
                        '‚ö†Ô∏è Veri Bulunamadƒ±', 
                        'Analiz edilmi≈ü veri bulunmuyor'
                    );
                    return;
                }

                // Update part changes
                PartChangesComponent.render('#changesContainer', analysisData.partChanges);
                
                // Update missing parts
                MissingPartsComponent.render('#missingPartsContainer', analysisData.missingRequired);
            },

            updateLoadingState(loading) {
                if (loading) {
                    LoadingComponent.show('#changesContainer', 'Analiz verisi y√ºkleniyor...');
                    LoadingComponent.show('#missingPartsContainer', 'Analiz verisi y√ºkleniyor...');
                }
            },

            updateErrorState(error) {
                if (error) {
                    ErrorComponent.show('#changesContainer', error);
                    ErrorComponent.show('#missingPartsContainer', 'Veri y√ºklenemedi');
                }
            },

            updateDateDisplay(date) {
                if (date) {
                    // Update title
                    const displayDate = DateUtils.formatTurkish(new Date(date));
                    document.getElementById('analysisTitle').textContent = `Par√ßa Deƒüi≈üiklikleri - ${displayDate}`;
                    
                    // Update active date indicators
                    const customDate = AppState.getSelectedCustomDate();
                    if (customDate === date) {
                        DatePickerComponent.setActiveCustomDate(true);
                        // Remove active from date cards
                        document.querySelectorAll('.date-card').forEach(card => {
                            card.classList.remove('active');
                        });
                    } else {
                        DatePickerComponent.setActiveDate(date);
                        DatePickerComponent.setActiveCustomDate(false);
                    }
                }
            }
        };

        // ===============================================================================
        // 7. CACHE MANAGER (Performance Optimization)
        // ===============================================================================

        const CacheManager = {
            cache: new Map(),
            TTL: 5 * 60 * 1000, // 5 minutes

            get(key) {
                const item = this.cache.get(key);
                if (!item) return null;
                
                if (Date.now() > item.expiry) {
                    this.cache.delete(key);
                    return null;
                }
                
                console.log('üíæ Cache hit for:', key);
                return item.data;
            },

            set(key, data) {
                console.log('üíæ Cache set for:', key);
                this.cache.set(key, {
                    data: data,
                    expiry: Date.now() + this.TTL
                });
            },

            invalidate(key) {
                console.log('üíæ Cache invalidated for:', key);
                this.cache.delete(key);
            },

            clear() {
                console.log('üíæ Cache cleared');
                this.cache.clear();
            }
        };

        // ===============================================================================
        // 8. SEARCH UTILITIES (Performance Optimization)
        // ===============================================================================

        const SearchUtils = {
            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            },

            searchVins(query, vins) {
                if (!query.trim()) return vins;
                
                const searchTerm = query.toLowerCase();
                return vins.filter(vin => 
                    vin.toLowerCase().startsWith(searchTerm)
                );
            }
        };

        // ===============================================================================
        // 9. APPLICATION BOOTSTRAP
        // ===============================================================================

        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ DOM loaded, initializing VPL Dashboard...');
            App.init().catch(error => {
                console.error('‚ùå App initialization failed:', error);
                ErrorComponent.show('#changesContainer', 'Uygulama ba≈ülatƒ±lamadƒ±: ' + error.message);
            });
        });

        // Global error handler
        window.addEventListener('error', function(event) {
            console.error('üí• Global error:', event.error);
            AppState.setError('Beklenmeyen bir hata olu≈ütu: ' + event.error.message);
        });

        // Unhandled promise rejection handler
        window.addEventListener('unhandledrejection', function(event) {
            console.error('üí• Unhandled promise rejection:', event.reason);
            AppState.setError('Beklenmeyen bir hata olu≈ütu: ' + event.reason);
            event.preventDefault();
        });

        // ===============================================================================
        // 10. PERFORMANCE MONITORING
        // ===============================================================================

        const PerformanceMonitor = {
            timers: new Map(),

            start(label) {
                this.timers.set(label, performance.now());
                console.log(`‚è±Ô∏è Timer started: ${label}`);
            },

            end(label) {
                const startTime = this.timers.get(label);
                if (startTime) {
                    const duration = performance.now() - startTime;
                    console.log(`‚è±Ô∏è Timer ended: ${label} - ${duration.toFixed(2)}ms`);
                    this.timers.delete(label);
                    return duration;
                }
                return null;
            },

            measure(label, fn) {
                this.start(label);
                const result = fn();
                this.end(label);
                return result;
            },

            async measureAsync(label, asyncFn) {
                this.start(label);
                const result = await asyncFn();
                this.end(label);
                return result;
            }
        };

        // ===============================================================================
        // 11. DEBUG UTILITIES (Development)
        // ===============================================================================

        const Debug = {
            enabled: false, // Set to true for development

            log(...args) {
                if (this.enabled) {
                    console.log('üêõ DEBUG:', ...args);
                }
            },

            logState() {
                if (this.enabled) {
                    console.log('üêõ DEBUG STATE:', {
                        currentDate: AppState.getCurrentDate(),
                        hasAnalysis: !!AppState.getCurrentAnalysis(),
                        selectedCustomDate: AppState.getSelectedCustomDate(),
                        isLoading: AppState.isLoading(),
                        error: AppState.getError()
                    });
                }
            },

            logPerformance() {
                if (this.enabled && performance.memory) {
                    console.log('üêõ DEBUG PERFORMANCE:', {
                        usedJSHeapSize: Math.round(performance.memory.usedJSHeapSize / 1048576) + 'MB',
                        totalJSHeapSize: Math.round(performance.memory.totalJSHeapSize / 1048576) + 'MB',
                        jsHeapSizeLimit: Math.round(performance.memory.jsHeapSizeLimit / 1048576) + 'MB'
                    });
                }
            }
        };

        // Make debug available globally in development
        if (window.location.hostname === 'localhost') {
            Debug.enabled = true;
            window.VPLDebug = Debug;
            window.VPLState = AppState;
            window.VPLCache = CacheManager;
        }

        // ===============================================================================
        // 12. ACCESSIBILITY IMPROVEMENTS
        // ===============================================================================

        const AccessibilityHelper = {
            init() {
                this.setupKeyboardNavigation();
                this.setupScreenReaderSupport();
                this.setupFocusManagement();
            },

            setupKeyboardNavigation() {
                // Add keyboard support for date cards
                document.addEventListener('keydown', (e) => {
                    if (e.target.classList.contains('date-card') && (e.key === 'Enter' || e.key === ' ')) {
                        e.preventDefault();
                        e.target.click();
                    }
                });
            },

            setupScreenReaderSupport() {
                // Add ARIA labels and descriptions
                const dateCards = document.querySelectorAll('.date-card');
                dateCards.forEach(card => {
                    card.setAttribute('role', 'button');
                    card.setAttribute('tabindex', '0');
                });
            },

            setupFocusManagement() {
                // Manage focus for modals
                const modal = document.getElementById('detailModal');
                if (modal) {
                    modal.addEventListener('keydown', (e) => {
                        if (e.key === 'Tab') {
                            // Trap focus within modal
                            const focusableElements = modal.querySelectorAll(
                                'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
                            );
                            
                            const firstElement = focusableElements[0];
                            const lastElement = focusableElements[focusableElements.length - 1];
                            
                            if (e.shiftKey) {
                                if (document.activeElement === firstElement) {
                                    e.preventDefault();
                                    lastElement.focus();
                                }
                            } else {
                                if (document.activeElement === lastElement) {
                                    e.preventDefault();
                                    firstElement.focus();
                                }
                            }
                        }
                    });
                }
            }
        };

        // Initialize accessibility features
        document.addEventListener('DOMContentLoaded', () => {
            AccessibilityHelper.init();
        });

        // ===============================================================================
        // 13. EXPORT GLOBAL INTERFACE
        // ===============================================================================

        // Export main App interface for HTML onclick handlers
        window.App = App;
        window.EventHandler = EventHandler;
        window.ModalComponent = ModalComponent;

        console.log('‚úÖ VPL Dashboard modules loaded successfully');
    </script>
</body>
</html>