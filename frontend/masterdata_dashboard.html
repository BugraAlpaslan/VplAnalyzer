<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MSAS Masterdata Analyzer - Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Fira Code', monospace;
            font-weight: 500;
            background-color: #0a0a0a;
            height: 100vh;
            display: grid;
            grid-template-columns: 1fr 2fr 2fr 1fr;
            grid-template-rows: 80px 1fr;
            gap: 1px;
            padding: 0;
        }

        /* Header Area */
        .header-area {
            grid-column: 1 / 5;
            background-color: #151515;
            border-bottom: 1px solid #1f1f1f;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            color: #e0e0e0;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .header-left h1 {
            font-size: 18px;
            font-weight: 600;
        }

        .system-indicator {
            background-color: #fb923c;
            color: #0a0a0a;
            padding: 4px 8px;
            font-size: 10px;
            font-weight: 600;
            border-radius: 2px;
        }

        .header-buttons {
            display: flex;
            gap: 10px;
        }

        .header-btn {
            background-color: #1a1a1a;
            color: #e0e0e0;
            border: 1px solid #2a2a2a;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 12px;
            font-family: 'Fira Code', monospace;
        }

        .header-btn:hover {
            background-color: #2a2a2a;
        }

        .header-btn.back {
            background-color: #2a2a2a;
            border-color: #444;
        }

        /* Left Sidebar */
        .sidebar {
            grid-column: 1 / 2;
            background-color: #111111;
            border-right: 1px solid #1f1f1f;
            padding: 20px;
            overflow-y: auto;
        }

        .welcome-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #1f1f1f;
        }

        .welcome-text {
            color: #777;
            font-size: 12px;
        }

        .username {
            color: #e0e0e0;
            font-size: 16px;
            font-weight: 600;
            margin-top: 2px;
        }

        .date-card {
            background-color: #1a1a1a;
            border: 1px solid #2a2a2a;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            position: relative;
        }

        .date-card:hover {
            background-color: #252525;
        }

        .date-card.active {
            background-color: #0a0a0a;
            border-color: #fb923c;
            box-shadow: 0 0 10px rgba(251, 146, 60, 0.3);
        }

        .date-text {
            font-size: 12px;
            font-weight: 600;
            color: #e0e0e0;
        }

        .date-details {
            font-size: 10px;
            color: #777;
            margin-top: 2px;
        }

        .reanalyze-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background-color: transparent;
            border: none;
            color: #777;
            cursor: pointer;
            font-size: 12px;
        }

        .reanalyze-btn:hover {
            color: #fb923c;
        }

        /* Main Content Areas */
        .tei-content {
            grid-column: 2 / 3;
            background-color: #131313;
            border-right: 1px solid #1f1f1f;
            padding: 20px;
            overflow-y: auto;
        }

        .osl-content {
            grid-column: 3 / 4;
            background-color: #131313;
            border-right: 1px solid #1f1f1f;
            padding: 20px;
            overflow-y: auto;
        }

        .content-title {
            font-size: 16px;
            font-weight: 600;
            color: #e0e0e0;
            margin-bottom: 20px;
            border-bottom: 1px solid #1f1f1f;
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .content-title .icon {
            font-size: 14px;
        }

        .tei-content .content-title .icon {
            color: #4ade80;
        }

        .osl-content .content-title .icon {
            color: #fb923c;
        }

        /* Statistics Cards */
        .stats-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .stat-card {
            background-color: #1a1a1a;
            border: 1px solid #2a2a2a;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stat-label {
            font-size: 11px;
            color: #777;
        }

        .stat-value {
            font-size: 14px;
            font-weight: 600;
            color: #e0e0e0;
        }

        .stat-value.success {
            color: #4ade80;
        }

        .stat-value.warning {
            color: #fb923c;
        }

        .stat-value.error {
            color: #f87171;
        }

        /* Results Container */
        .results-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .result-item {
            background-color: #1a1a1a;
            border: 1px solid #2a2a2a;
            padding: 15px;
            cursor: pointer;
            position: relative;
        }

        .result-item:hover {
            background-color: #252525;
        }

        .result-item.success {
            border-left: 3px solid #4ade80;
        }

        .result-item.warning {
            border-left: 3px solid #fb923c;
        }

        .result-item.error {
            border-left: 3px solid #f87171;
        }

        .result-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .result-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .result-title {
            font-size: 12px;
            font-weight: 600;
            color: #e0e0e0;
        }

        .result-description {
            font-size: 10px;
            color: #777;
        }

        .result-count {
            background-color: #2a2a2a;
            color: #e0e0e0;
            padding: 2px 8px;
            font-size: 10px;
            font-weight: 600;
            border-radius: 2px;
        }

        .details-btn {
            background-color: #2a2a2a;
            color: #e0e0e0;
            border: 1px solid #444;
            padding: 6px 12px;
            font-size: 10px;
            font-family: 'Fira Code', monospace;
            cursor: pointer;
            white-space: nowrap;
        }

        .details-btn:hover {
            background-color: #444;
        }

        /* Right Sidebar */
        .right-sidebar {
            grid-column: 4 / 5;
            background-color: #111111;
            padding: 20px;
            overflow-y: auto;
        }

        .compliance-section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: #fb923c;
            margin-bottom: 15px;
            border-bottom: 1px solid #1f1f1f;
            padding-bottom: 8px;
        }

        .compliance-overview {
            background-color: #1a1a1a;
            border: 1px solid #2a2a2a;
            padding: 15px;
            margin-bottom: 15px;
        }

        .compliance-score {
            text-align: center;
            margin-bottom: 15px;
        }

        .score-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: conic-gradient(#4ade80 0deg, #4ade80 0deg, #2a2a2a 0deg);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            position: relative;
        }

        .score-circle::before {
            content: '';
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: #1a1a1a;
            position: absolute;
        }

        .score-text {
            font-size: 14px;
            font-weight: 600;
            color: #e0e0e0;
            z-index: 1;
        }

        .score-label {
            font-size: 10px;
            color: #777;
            text-align: center;
        }

        .compliance-breakdown {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .breakdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #2a2a2a;
        }

        .breakdown-label {
            font-size: 10px;
            color: #777;
        }

        .breakdown-value {
            font-size: 10px;
            font-weight: 600;
            color: #e0e0e0;
        }

        .breakdown-value.success {
            color: #4ade80;
        }

        .breakdown-value.warning {
            color: #fb923c;
        }

        .breakdown-value.error {
            color: #f87171;
        }

        /* CK Module Section */
        .ck-module-section {
            background-color: #1a1a1a;
            border: 1px solid #2a2a2a;
            padding: 15px;
            margin-bottom: 15px;
        }

        .ck-title {
            font-size: 12px;
            font-weight: 600;
            color: #fb923c;
            margin-bottom: 10px;
        }

        .ck-stats {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .ck-stat {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
        }

        .ck-stat-label {
            color: #777;
        }

        .ck-stat-value {
            color: #e0e0e0;
            font-weight: 600;
        }

        /* Loading States */
        .loading {
            text-align: center;
            padding: 40px;
            color: #777;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #777;
        }

        .empty-state h3 {
            font-size: 14px;
            margin-bottom: 8px;
            color: #999;
        }

        .empty-state p {
            font-size: 11px;
            line-height: 1.4;
        }
        .recent-dates-section {
    margin-bottom: 20px;
}

.section-header {
    color: #fb923c;
    font-size: 12px;
    font-weight: 600;
    margin-bottom: 10px;
    padding-bottom: 5px;
    border-bottom: 1px solid #1f1f1f;
}

/* Date card active state i√ßin fb923c rengi kullan */
.date-card.active {
    background-color: #0a0a0a;
    border-color: #fb923c;
    box-shadow: 0 0 10px rgba(251, 146, 60, 0.3);
}

/* Scroll bar renklerini d√ºzelt */


        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
        }

        .modal-overlay.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: #1a1a1a;
            border: 1px solid #2a2a2a;
            width: 90%;
            max-width: 1200px;
            height: 80%;
            max-height: 800px;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            background-color: #151515;
            border-bottom: 1px solid #2a2a2a;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            color: #e0e0e0;
            font-size: 16px;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            color: #777;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
        }

        .close-btn:hover {
            color: #e0e0e0;
        }

        .modal-filters {
            background-color: #0f0f0f;
            border-bottom: 1px solid #2a2a2a;
            padding: 15px 20px;
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .filter-input {
            flex: 1;
            padding: 8px 12px;
            background-color: #2a2a2a;
            border: 1px solid #444;
            color: #e0e0e0;
            font-family: 'Fira Code', monospace;
            font-size: 12px;
        }

        .filter-input:focus {
            outline: none;
            border-color: #666;
        }

        .filter-select {
            padding: 8px 12px;
            background-color: #2a2a2a;
            border: 1px solid #444;
            color: #e0e0e0;
            font-family: 'Fira Code', monospace;
            font-size: 12px;
        }
        /* Custom Date Section */
.custom-date-section {
    margin-bottom: 20px;
}

.date-picker-container {
    background-color: #1a1a1a;
    border: 1px solid #2a2a2a;
    padding: 12px;
    margin-bottom: 10px;
}

.date-picker-label {
    color: #fb923c;
    font-size: 11px;
    font-weight: 600;
    margin-bottom: 8px;
    display: block;
}

.date-input {
    width: 100%;
    background-color: #0f0f0f;
    border: 1px solid #2a2a2a;
    color: #e0e0e0;
    padding: 8px;
    font-family: 'Fira Code', monospace;
    font-size: 11px;
    margin-bottom: 8px;
}

.date-input:focus {
    outline: none;
    border-color: #fb923c;
}

.date-input::-webkit-calendar-picker-indicator {
    filter: invert(1);
    cursor: pointer;
}

.load-date-btn {
    width: 100%;
    background-color: #fb923c;
    color: #0f0f0f;
    border: none;
    padding: 8px;
    font-family: 'Fira Code', monospace;
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
    margin-bottom: 8px;
}

.load-date-btn:hover {
    background-color: #f97316;
}

.load-date-btn:disabled {
    background-color: #2a2a2a;
    color: #777;
    cursor: not-allowed;
}

.selected-date-container {
    background-color: #0f0f0f;
    border: 1px solid #2a2a2a;
    padding: 10px;
    display: none;
}

.selected-date-container.show {
    display: block;
}

.selected-date-label {
    color: #777;
    font-size: 9px;
    margin-bottom: 4px;
}

.selected-date-display {
    background-color: #2a2a2a;
    border: 1px solid #444;
    padding: 8px;
    cursor: pointer;
    position: relative;
}

.selected-date-display:hover {
    background-color: #444;
}

.selected-date-display.active {
    background-color: #0a0a0a;
    border-color: #fb923c;
    box-shadow: 0 0 0 1px #fb923c;
}

.selected-date-text {
    color: #e0e0e0;
    font-size: 11px;
    font-weight: 600;
}

.selected-date-subtitle {
    color: #777;
    font-size: 9px;
    margin-top: 2px;
}

.custom-reanalyze-btn {
    position: absolute;
    right: 6px;
    top: 50%;
    transform: translateY(-50%);
    background-color: transparent;
    border: none;
    color: #777;
    cursor: pointer;
    font-size: 11px;
    padding: 2px;
}

.custom-reanalyze-btn:hover {
    color: #e0e0e0;
    background-color: #fb923c;
}
/* Sidebar scroll d√ºzeltmesi */
.sidebar {
    height: calc(110vh - 90px); /* Header height'ƒ±nƒ± √ßƒ±kar */
    overflow-y: auto;
    padding: 20px;
}

/* Welcome section'ƒ± sabit tut */
.welcome-section {
    flex-shrink: 0;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid #1f1f1f;
}

/* Date sections'larƒ± daha kompakt yap */
.recent-dates-section {
    margin-bottom: 15px; /* 20px'den 15px'e d√º≈ü√ºr */
}

.custom-date-section {
    margin-bottom: 15px; /* 20px'den 15px'e d√º≈ü√ºr */
}

/* Date picker container'ƒ± daha k√º√ß√ºk yap */
.date-picker-container {
    padding: 10px; /* 12px'den 10px'e d√º≈ü√ºr */
    margin-bottom: 8px; /* 10px'den 8px'e d√º≈ü√ºr */
}

/* Selected date container'ƒ± daha k√º√ß√ºk yap */
.selected-date-container {
    padding: 8px; /* 10px'den 8px'e d√º≈ü√ºr */
}

/* Date card'larƒ± daha k√º√ß√ºk yap */
.date-card {
    padding: 10px; /* 12px'den 10px'e d√º≈ü√ºr */
    margin-bottom: 5px; /* 8px'den 5px'e d√º≈ü√ºr */
}
        .modal-body {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .modal-footer {
            background-color: #0f0f0f;
            border-top: 1px solid #2a2a2a;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .export-btn {
            background-color: #2a2a2a;
            border: 1px solid #444;
            color: #e0e0e0;
            padding: 8px 16px;
            font-size: 12px;
            font-family: 'Fira Code', monospace;
            cursor: pointer;
        }

        .export-btn:hover {
            background-color: #444;
        }

        /* Modal Content Items */
        .modal-item {
            background-color: #252525;
            border: 1px solid #2a2a2a;
            padding: 15px;
            margin-bottom: 10px;
        }

        .modal-item-header {
            color: #e0e0e0;
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .modal-item-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            font-size: 11px;
        }

        .modal-item-field {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px solid #333;
        }

        .field-label {
            color: #777;
        }

        .field-value {
            color: #e0e0e0;
            font-weight: 500;
        }

        .field-value.success {
            color: #4ade80;
        }

        .field-value.error {
            color: #f87171;
        }

        .field-value.warning {
            color: #fb923c;
        }

        .violations-list {
            margin-top: 10px;
        }

        .violation-item {
            background-color: #1a1a1a;
            border-left: 3px solid #f87171;
            padding: 8px;
            margin-bottom: 4px;
            font-size: 10px;
            color: #f87171;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .result-item {
            animation: fadeIn 0.3s ease-out;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            body {
                grid-template-columns: 250px 1fr 1fr 200px;
            }
        }

        @media (max-width: 768px) {
            body {
                grid-template-columns: 1fr;
                grid-template-rows: 80px auto auto auto;
            }
            
            .sidebar {
                grid-column: 1;
                grid-row: 2;
                border-right: none;
                border-bottom: 1px solid #1f1f1f;
            }
            
            .tei-content {
                grid-column: 1;
                grid-row: 3;
                border-right: none;
                border-bottom: 1px solid #1f1f1f;
            }
            
            .osl-content {
                grid-column: 1;
                grid-row: 4;
                border-right: none;
                border-bottom: 1px solid #1f1f1f;
            }
            
            .right-sidebar {
                grid-column: 1;
                grid-row: 5;
            }
        }
    </style>
</head>
<body>
    <!-- Header Area -->
    <div class="header-area">
        <div class="header-left">
            <h1>MSAS Masterdata Analyzer</h1>
            <span class="system-indicator">MASTERDATA</span>
        </div>
        <div class="header-buttons">
            <button class="header-btn back" onclick="goBack()">‚Üê Dashboard Selection</button>
            <button class="header-btn" onclick="manualAnalysis()">Manuel Analysis</button>
        </div>
    </div>

    <!-- Left Sidebar -->
<div class="sidebar">
    <div class="welcome-section">
        <div class="welcome-text">Masterdata Analysis</div>
        <div class="username" id="currentUser">Admin</div>
    </div>
    
    <!-- Recent Dates Section - VPL gibi -->
    <div class="recent-dates-section">
        <div class="section-header">üìÖ Son 5 G√ºn</div>
        <div id="dateCards">
            <!-- Dynamic date cards will be generated -->
        </div>
    </div>
    <!-- Custom Date Section -->
<div class="custom-date-section">
    <div class="section-header">üóìÔ∏è Select special date</div>
    <div class="date-picker-container">
        <label class="date-picker-label" for="customDate">Analysis Date:</label>
        <input type="date" id="customDate" class="date-input">
        <button class="load-date-btn" id="loadDateBtn" onclick="loadCustomDate()">
            üìä Load Custom Date
        </button>
    </div>
    
    <div class="selected-date-container" id="selectedDateContainer">
        <div class="selected-date-label">Se√ßili √ñzel Tarih:</div>
        <div class="selected-date-display" id="selectedDateDisplay" onclick="loadSelectedCustomDate()">
            <div class="selected-date-text" id="selectedDateText"></div>
            <div class="selected-date-subtitle"> Click for analysis</div>
            <button class="custom-reanalyze-btn" onclick="event.stopPropagation(); reanalyzeCustomDate()">‚Üª</button>
        </div>
    </div>
</div>
</div>

    <!-- TEI Analysis Content -->
    <div class="tei-content">
        <div class="content-title">
            <span class="icon">üìÑ</span>
            <span id="teiTitle">TEI analizi  </span>
        </div>
        
        <div class="stats-container" id="teiStats">
            <!-- TEI statistics will be loaded here -->
            <div class="loading">TEI istatistikleri y√ºkleniyor...</div>
        </div>
        
        <div class="results-container" id="teiResults">
            <!-- TEI results will be loaded here -->
            <div class="loading">TEI analysis sonu√ßlarƒ± y√ºkleniyor...</div>
        </div>
    </div>

    <!-- OSL Analysis Content -->
    <div class="osl-content">
        <div class="content-title">
            <span class="icon">‚öôÔ∏è</span>
            <span id="oslTitle">OSL analizi </span>
        </div>
        
        <div class="stats-container" id="oslStats">
            <!-- OSL statistics will be loaded here -->
            <div class="loading">OSL istatistikleri y√ºkleniyor...</div>
        </div>
        
        <div class="results-container" id="oslResults">
            <!-- OSL results will be loaded here -->
            <div class="loading">OSL analysis sonu√ßlarƒ± y√ºkleniyor...</div>
        </div>
    </div>

    <!-- Right Sidebar -->
    <div class="right-sidebar">
        <div class="compliance-section">
            <div class="section-title">üìä Uyumluluk Skoru</div>
            
            <div class="compliance-overview">
                <div class="compliance-score">
                    <div class="score-circle" id="scoreCircle">
                        <span class="score-text" id="scoreText">--%</span>
                    </div>
                    <div class="score-label">Genel Uyumluluk</div>
                </div>
                
                <div class="compliance-breakdown" id="complianceBreakdown">
                    <!-- Compliance breakdown will be loaded here -->
                </div>
            </div>
            
            <div class="ck-module-section">
                <div class="ck-title">üîß CK Mod√ºl√º Durumu</div>
                <div class="ck-stats" id="ckStats">
                    <!-- CK module stats will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Overlay -->
    <div class="modal-overlay" id="detailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Detaylar</h3>
                <button class="close-btn" onclick="closeModal()">‚úï</button>
            </div>
            <div class="modal-filters">
                <input type="text" class="filter-input" id="searchInput" placeholder="üîç ƒ∞√ßerik ara...">
                <select class="filter-select" id="filterSelect" onchange="applyFilter()">
                    <option value="all">T√ºm Sonu√ßlar</option>
                    <option value="violations">Sadece Violation'lar</option>
                    <option value="compliant">Sadece Uyumlu</option>
                </select>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Dynamic content -->
            </div>
            <div class="modal-footer">
                <div id="resultsCount">Toplam: 0 sonu√ß</div>
                <button class="export-btn" onclick="exportModalData()">üì• CSV Export</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentAnalysisData = null;
        let currentModalData = null;

        // Load masterdata analysis for specific date
        function loadMasterdataAnalysis(date) {
    console.log('üîç Loading masterdata analysis for date:', date);
    
    // UI state g√ºncellemesi
    updateActiveDate(date);
    updateTitles(date);
    showLoadingState();
    
    const apiUrl = `/api/masterdata/analysis/${date}`;
    console.log('üì° Fetching:', apiUrl);
    
    fetch(apiUrl)
        .then(response => {
            console.log('üì• Response status:', response.status);
            console.log('üì• Response headers:', response.headers);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('üìä Raw response data:', data);
            console.log('üìä Response success:', data.success);
            console.log('üìä Response keys:', Object.keys(data));
            
            if (data.success && data.data) {
                console.log('üìä Data keys:', Object.keys(data.data));
                
                // Veriyi normalize et
                const normalizedData = normalizeMasterdataResponse(data);
                console.log('‚úÖ Normalized data:', normalizedData);
                
                // UI'yi g√ºncelle
                updateMasterdataDisplay(normalizedData);
                console.log('‚úÖ Masterdata analysis loaded successfully');
            } else {
                console.warn('‚ö†Ô∏è API returned error:', data.message);
                showErrorState('analysis verisi y√ºklenemedi: ' + (data.message || 'Bilinmeyen hata'));
            }
        })
        .catch(error => {
            console.error('‚ùå Analysis load error:', error);
            showErrorState('analysis verisi y√ºklenirken bir hata olu≈ütu: ' + error.message);
        });
}
function updateComplianceOverview(analysisData) {
    console.log('üé® Updating compliance overview');
    
    try {
        if (analysisData.osl_analysis_results && analysisData.osl_analysis_results.validation_statistics) {
            const stats = analysisData.osl_analysis_results.validation_statistics;
            const score = stats.overall_compliance_rate || 0;
            
            // Score circle g√ºncelle
            updateScoreCircle(score);
            const scoreElement = document.getElementById('scoreText');
            if (scoreElement) {
                scoreElement.textContent = `${score.toFixed(0)}%`;
            }
            
            // ‚úÖ GELƒ∞≈ûTƒ∞Rƒ∞LMƒ∞≈û BREAKDOWN - Sayƒ±lar ile birlikte
            const breakdownHtml = `
                <div class="breakdown-item">
                    <span class="breakdown-label">Required Parametreler</span>
                    <div class="breakdown-details">
                        <span class="breakdown-value ${(stats.required_param_compliance_rate || 0) > 90 ? 'success' : 'error'}">${(stats.required_param_compliance_rate || 0).toFixed(1)}%</span>
                        <span class="breakdown-count">(${stats.total_parts - (stats.required_param_violations || 0)}/${stats.total_parts})</span>
                    </div>
                </div>
                <div class="breakdown-item">
                    <span class="breakdown-label">PROJECT Parametreleri</span>
                    <div class="breakdown-details">
                        <span class="breakdown-value ${(stats.project_compliance_rate || 0) > 90 ? 'success' : 'warning'}">${(stats.project_compliance_rate || 0).toFixed(1)}%</span>
                        <span class="breakdown-count">(${stats.total_parts - (stats.project_param_violations || 0)}/${stats.total_parts})</span>
                    </div>
                </div>
                <div class="breakdown-item">
                    <span class="breakdown-label">CK Mod√ºl Uyumluluƒüu</span>
                    <div class="breakdown-details">
                        <span class="breakdown-value ${(stats.ck_compliance_rate || 0) > 80 ? 'success' : 'error'}">${(stats.ck_compliance_rate || 0).toFixed(1)}%</span>
                        <span class="breakdown-count">(${(stats.ck_module_parts || 0) - (stats.ck_module_violations || 0)}/${stats.ck_module_parts || 0})</span>
                    </div>
                </div>
            `;
            
            const breakdownElement = document.getElementById('complianceBreakdown');
            if (breakdownElement) {
                breakdownElement.innerHTML = breakdownHtml;
            }
            
            // ‚úÖ GELƒ∞≈ûTƒ∞Rƒ∞LMƒ∞≈û CK STATS - Daha detaylƒ±
            const ckStatsHtml = `
                <div class="ck-stat">
                    <span class="ck-stat-label">CK Mod√ºl√º Toplam:</span>
                    <span class="ck-stat-value success">${stats.ck_module_parts || 0}</span>
                </div>
                <div class="ck-stat">
                    <span class="ck-stat-label">CK Ba≈üarƒ±lƒ±:</span>
                    <span class="ck-stat-value success">${(stats.ck_module_parts || 0) - (stats.ck_module_violations || 0)}</span>
                </div>
                <div class="ck-stat">
                    <span class="ck-stat-label">CK Violation:</span>
                    <span class="ck-stat-value error">${stats.ck_module_violations || 0}</span>
                </div>
                <div class="ck-stat">
                    <span class="ck-stat-label">CK Uyumluluk:</span>
                    <span class="ck-stat-value ${(stats.ck_compliance_rate || 0) > 80 ? 'success' : 'error'}">${(stats.ck_compliance_rate || 0).toFixed(1)}%</span>
                </div>
                <div class="ck-stat-separator"></div>
                <div class="ck-stat">
                    <span class="ck-stat-label">Hesaplama:</span>
                    <span class="ck-stat-formula">${(stats.ck_module_parts || 0) - (stats.ck_module_violations || 0)} / ${stats.ck_module_parts || 0}</span>
                </div>
            `;
            
            const ckStatsElement = document.getElementById('ckStats');
            if (ckStatsElement) {
                ckStatsElement.innerHTML = ckStatsHtml;
            }
            
            console.log('‚úÖ Compliance overview updated with real CK data:', {
                ckTotal: stats.ck_module_parts,
                ckViolations: stats.ck_module_violations,
                ckRate: (stats.ck_compliance_rate || 0).toFixed(1) + '%'
            });
        } else {
            console.warn('‚ö†Ô∏è No validation statistics found for compliance overview');
        }
    } catch (error) {
        console.error('‚ùå Error updating compliance overview:', error);
    }
}
        // Update masterdata display with real data
function loadCustomDate() {
    const dateInput = document.getElementById('customDate');
    const selectedDate = dateInput ? dateInput.value : null;
    
    if (!selectedDate) {
        alert('L√ºtfen bir tarih se√ßin');
        return;
    }
    
    loadMasterdataAnalysis(selectedDate);
    showSelectedCustomDate(selectedDate);
}

function showSelectedCustomDate(date) {
    const container = document.getElementById('selectedDateContainer');
    const textElement = document.getElementById('selectedDateText');
    
    if (container && textElement) {
        const displayDate = formatDateTurkish(new Date(date));
        textElement.textContent = displayDate;
        container.classList.add('show');
    }
}   // Mevcut updateMasterdataDisplay fonksiyonunun ba≈üƒ±na bu satƒ±rƒ± ekleyin:
function updateMasterdataDisplay(analysisData) {
    console.log('üé® Updating masterdata display with:', analysisData);
    
    // ‚úÖ FIX: Set global variable for modal access
    currentAnalysisData = analysisData;
    console.log('‚úÖ currentAnalysisData set:', !!currentAnalysisData);
    
    try {
        // Mevcut kod devam ediyor...
        updateTEIAnalysis(analysisData.tei_analysis_results);
        console.log('‚úÖ TEI analysis updated');
        
        updateOSLAnalysis(analysisData.osl_analysis_results);
        console.log('‚úÖ OSL analysis updated');
        
        updateComplianceOverview(analysisData);
        console.log('‚úÖ Compliance overview updated');
        
    } catch (error) {
        console.error('‚ùå Error updating masterdata display:', error);
        showErrorState('Veri g√∂sterilirken hata olu≈ütu: ' + error.message);
    }
}
function updateActiveDate(date) {
    // Date card'larƒ± g√ºncelle
    document.querySelectorAll('.date-card').forEach(card => {
        card.classList.remove('active');
    });
    
    const targetCard = document.querySelector(`[data-date="${date}"]`);
    if (targetCard) {
        targetCard.classList.add('active');
    }
}
function normalizeMasterdataResponse(rawResponse) {
    console.log('üîÑ Normalizing masterdata response:', rawResponse);
    
    // Backend'den gelen yapƒ± kontrol et
    let analysisData;
    
    if (rawResponse.data && rawResponse.data.analysis) {
        // Wrapped format: { success: true, data: { analysis: {...} } }
        analysisData = rawResponse.data.analysis;
        console.log('‚úÖ Found wrapped analysis data');
    } else if (rawResponse.data) {
        // Direct format: { success: true, data: {...} }
        analysisData = rawResponse.data;
        console.log('‚úÖ Found direct analysis data');
    } else {
        console.error('‚ùå No analysis data found in response');
        throw new Error('Invalid response structure');
    }
    
    // TEI analysis kontrol et
    if (!analysisData.tei_analysis_results) {
        console.error('‚ùå No TEI analysis results found');
        throw new Error('TEI analysis results missing');
    }
    
    // OSL analysis kontrol et
    if (!analysisData.osl_analysis_results) {
        console.error('‚ùå No OSL analysis results found');
        throw new Error('OSL analysis results missing');
    }
    
    console.log('‚úÖ Response validation passed');
    return analysisData;
}
function updateScoreCircle(score) {
    const circle = document.getElementById('scoreCircle');
    if (!circle) return;
    
    const degrees = (score / 100) * 360;
    let color = '#f87171'; // Error red
    
    if (score > 80) color = '#4ade80'; // Success green
    else if (score > 60) color = '#fb923c'; // Warning orange
    
    circle.style.background = `conic-gradient(${color} 0deg, ${color} ${degrees}deg, #2a2a2a ${degrees}deg)`;
}
function formatDateTurkish(date) {
    const months = [
        'Ocak', '≈ûubat', 'Mart', 'Nisan', 'Mayƒ±s', 'Haziran',
        'Temmuz', 'Aƒüustos', 'Eyl√ºl', 'Ekim', 'Kasƒ±m', 'Aralƒ±k'
    ];
    
    const day = date.getDate();
    const month = months[date.getMonth()];
    const year = date.getFullYear();
    
    return `${day} ${month} ${year}`;
}

// 10. Modal functions for TEI results
function openTEIModal(type) {
    console.log('üîç Opening TEI modal for type:', type, 'Data available:', !!currentAnalysisData);
    
    if (!currentAnalysisData || !currentAnalysisData.tei_analysis_results) {
        console.error('‚ùå No TEI analysis data available');
        alert('TEI analysis verisi bulunamadƒ±. L√ºtfen √∂nce analysis √ßalƒ±≈ütƒ±rƒ±n.');
        return;
    }
    
    const modal = document.getElementById('detailModal');
    const modalTitle = document.getElementById('modalTitle');
    const searchInput = document.getElementById('searchInput');
    
    if (!modal || !modalTitle || !searchInput) {
        console.error('‚ùå Modal elements not found in DOM');
        return;
    }
    
    let titleText = '';
    let data = [];
    
    const teiResults = currentAnalysisData.tei_analysis_results;
    console.log('üìä TEI Results keys:', Object.keys(teiResults));
    
    switch (type) {
        case 'not_found':
            titleText = `TEI'de Bulunamayan Par√ßalar (${teiResults.not_found_in_tei?.length || 0})`;
            data = (teiResults.not_found_in_tei || []).map(part => ({ 
                vpl_part_reference: part,
                status: 'TEI\'de bulunamadƒ±'
            }));
            break;
        case 'inner_ref_errors':
            titleText = `Inner Reference Hatalarƒ± (${teiResults.inner_reference_incorrect?.length || 0})`;
            data = teiResults.inner_reference_incorrect || [];
            break;
        case 'missing_desc':
            titleText = `Eksik A√ßƒ±klamalar (${teiResults.missing_description?.length || 0})`;
            data = teiResults.missing_description || [];
            break;
        default:
            console.error('‚ùå Unknown TEI modal type:', type);
            return;
    }
    
    console.log('üìä Modal data prepared:', data.length, 'items');
    
    modalTitle.textContent = titleText;
    searchInput.value = '';
    searchInput.placeholder = 'üîç Part referansƒ± ara...';
    
    currentModalData = { type: 'tei', subtype: type, data: data };
    renderTEIModalContent(data);
    
    // Clear previous event listeners and set new ones
    searchInput.onkeyup = null;
    searchInput.oninput = null;
    searchInput.addEventListener('input', function() {
        filterTEIModalContent(this.value);
    });
    
    modal.classList.add('show');
    console.log('‚úÖ TEI Modal opened successfully');
}

// 11. Modal functions for OSL results
function openOSLModal(type) {
    console.log('üîç Opening OSL modal for type:', type, 'Data available:', !!currentAnalysisData);
    
    if (!currentAnalysisData || !currentAnalysisData.osl_analysis_results) {
        console.error('‚ùå No OSL analysis data available');
        alert('OSL analysis verisi bulunamadƒ±. L√ºtfen √∂nce analysis √ßalƒ±≈ütƒ±rƒ±n.');
        return;
    }
    
    const modal = document.getElementById('detailModal');
    const modalTitle = document.getElementById('modalTitle');
    const searchInput = document.getElementById('searchInput');
    
    if (!modal || !modalTitle || !searchInput) {
        console.error('‚ùå Modal elements not found in DOM');
        return;
    }
    
    let titleText = '';
    let data = [];
    
    const oslResults = currentAnalysisData.osl_analysis_results;
    console.log('üìä OSL Results keys:', Object.keys(oslResults));
    
    if (oslResults.validation_results) {
        switch (type) {
            case 'all_validation':
                titleText = `T√ºm Validation Sonu√ßlarƒ± (${oslResults.validation_results.length})`;
                data = oslResults.validation_results;
                break;
            case 'required_violations':
                titleText = `Required Parametre Violation'larƒ±`;
                data = oslResults.validation_results.filter(r => 
                    r.required_compliance && !r.required_compliance.is_compliant);
                titleText += ` (${data.length})`;
                break;
            case 'ck_violations':
                titleText = `CK Mod√ºl√º Violation'larƒ±`;
                data = oslResults.validation_results.filter(r => 
                    r.ck_module_compliance && 
                    r.ck_module_compliance.is_ck_module && 
                    !r.ck_module_compliance.is_compliant);
                titleText += ` (${data.length})`;
                break;
            default:
                console.error('‚ùå Unknown OSL modal type:', type);
                return;
        }
    }
    
    console.log('üìä Modal data prepared:', data.length, 'items');
    
    modalTitle.textContent = titleText;
    searchInput.value = '';
    searchInput.placeholder = 'üîç Inner reference ara...';
    
    currentModalData = { type: 'osl', subtype: type, data: data };
    renderOSLModalContent(data);
    
    // Clear previous event listeners and set new ones
    searchInput.onkeyup = null;
    searchInput.oninput = null;
    searchInput.addEventListener('input', function() {
        filterOSLModalContent(this.value);
    });
    
    modal.classList.add('show');
    console.log('‚úÖ OSL Modal opened successfully');
}
// 12. Render TEI modal content
function renderTEIModalContent(data) {
    const modalBody = document.getElementById('modalBody');
    const resultsCount = document.getElementById('resultsCount');
    
    if (!modalBody || !resultsCount) {
        console.error('‚ùå Modal body elements not found');
        return;
    }
    
    if (!data || data.length === 0) {
        modalBody.innerHTML = '<div class="empty-state"><h3>Sonu√ß bulunamadƒ±</h3></div>';
        resultsCount.textContent = 'Toplam: 0 sonu√ß';
        return;
    }
    
    resultsCount.textContent = `Toplam: ${data.length} sonu√ß`;
    
    let contentHtml = '';
    
    data.forEach((item, index) => {
        if (typeof item === 'string') {
            // Simple string data (not found items)
            contentHtml += `
                <div class="modal-item">
                    <div class="modal-item-header">Part ${index + 1}: ${item}</div>
                    <div class="modal-item-content">
                        <div class="modal-item-field">
                            <span class="field-label">VPL Referansƒ±:</span>
                            <span class="field-value error">${item}</span>
                        </div>
                        <div class="modal-item-field">
                            <span class="field-label">Durum:</span>
                            <span class="field-value error">TEI'de bulunamadƒ±</span>
                        </div>
                    </div>
                </div>
            `;
        } else {
            // Object data
            let statusClass = 'success';
            let statusText = 'Uyumlu';
            
            if (item.error_reason) {
                statusClass = 'error';
                statusText = 'Hata';
            } else if (item.status && item.status.includes('bulunamadƒ±')) {
                statusClass = 'error';
                statusText = item.status;
            } else if (!item.description_exists) {
                statusClass = 'warning';
                statusText = 'Eksik a√ßƒ±klama';
            }
            
            contentHtml += `
                <div class="modal-item">
                    <div class="modal-item-header">${item.vpl_part_reference || item.customer_reference || 'Part ' + (index + 1)}</div>
                    <div class="modal-item-content">
                        <div class="modal-item-field">
                            <span class="field-label">Customer Reference:</span>
                            <span class="field-value">${item.customer_reference || item.vpl_part_reference || '-'}</span>
                        </div>
                        <div class="modal-item-field">
                            <span class="field-label">Inner Reference:</span>
                            <span class="field-value">${item.inner_reference || '-'}</span>
                        </div>
                        <div class="modal-item-field">
                            <span class="field-label">Part A√ßƒ±klamasƒ±:</span>
                            <span class="field-value">${item.part_description || 'Yok'}</span>
                        </div>
                        <div class="modal-item-field">
                            <span class="field-label">Durum:</span>
                            <span class="field-value ${statusClass}">${statusText}</span>
                        </div>
                        ${item.expected_inner ? `
                            <div class="modal-item-field">
                                <span class="field-label">Beklenen Inner:</span>
                                <span class="field-value warning">${item.expected_inner}</span>
                            </div>
                            <div class="modal-item-field">
                                <span class="field-label">Ger√ßek Inner:</span>
                                <span class="field-value error">${item.actual_inner}</span>
                            </div>
                        ` : ''}
                    </div>
                    ${item.error_reason ? `
                        <div class="violations-list">
                            <div class="violation-item">${item.error_reason}</div>
                        </div>
                    ` : ''}
                </div>
            `;
        }
    });
    
    modalBody.innerHTML = contentHtml;
    console.log('‚úÖ TEI Modal content rendered:', data.length, 'items');
}
function renderOSLModalContent(data) {
    const modalBody = document.getElementById('modalBody');
    const resultsCount = document.getElementById('resultsCount');
    
    if (!modalBody || !resultsCount) {
        console.error('‚ùå Modal body elements not found');
        return;
    }
    
    if (!data || data.length === 0) {
        modalBody.innerHTML = '<div class="empty-state"><h3>Sonu√ß bulunamadƒ±</h3></div>';
        resultsCount.textContent = 'Toplam: 0 sonu√ß';
        return;
    }
    
    resultsCount.textContent = `Toplam: ${data.length} sonu√ß`;
    
    let contentHtml = '';
    
    data.forEach((item, index) => {
        const complianceClass = item.overall_compliance ? 'success' : 'error';
        const complianceText = item.overall_compliance ? 'Uyumlu' : 'Violation Var';
        
        contentHtml += `
            <div class="modal-item">
                <div class="modal-item-header">${item.inner_reference || 'Inner Ref ' + (index + 1)}</div>
                <div class="modal-item-content">
                    <div class="modal-item-field">
                        <span class="field-label">Compliance Score:</span>
                        <span class="field-value ${complianceClass}">${item.compliance_score?.toFixed(1) || 0}%</span>
                    </div>
                    <div class="modal-item-field">
                        <span class="field-label">Genel Durum:</span>
                        <span class="field-value ${complianceClass}">${complianceText}</span>
                    </div>
                    <div class="modal-item-field">
                        <span class="field-label">MODULE:</span>
                        <span class="field-value ${item.required_compliance?.has_module ? 'success' : 'error'}">${item.required_compliance?.module_value || 'Yok'}</span>
                    </div>
                    <div class="modal-item-field">
                        <span class="field-label">PART_FAMILY:</span>
                        <span class="field-value ${item.required_compliance?.has_part_family ? 'success' : 'error'}">${item.required_compliance?.part_family_value || 'Yok'}</span>
                    </div>
                    <div class="modal-item-field">
                        <span class="field-label">PROJECT:</span>
                        <span class="field-value ${item.project_compliance?.has_project ? 'success' : 'warning'}">${item.project_compliance?.project_value || 'Yok'}</span>
                    </div>
                    <div class="modal-item-field">
                        <span class="field-label">PROJECT1:</span>
                        <span class="field-value ${item.project_compliance?.has_project1 ? 'success' : 'warning'}">${item.project_compliance?.project1_value || 'Yok'}</span>
                    </div>
                    ${item.ck_module_compliance?.is_ck_module ? `
                        <div class="modal-item-field">
                            <span class="field-label">LABEL_POSITION:</span>
                            <span class="field-value ${item.ck_module_compliance.has_label_position ? 'success' : 'error'}">${item.ck_module_compliance.label_position_value || 'Yok'}</span>
                        </div>
                        <div class="modal-item-field">
                            <span class="field-label">LABEL_TYPE:</span>
                            <span class="field-value ${item.ck_module_compliance.has_label_type ? 'success' : 'error'}">${item.ck_module_compliance.label_type_value || 'Yok'}</span>
                        </div>
                    ` : ''}
                </div>
                ${item.violation_reasons && item.violation_reasons.length > 0 ? `
                    <div class="violations-list">
                        ${item.violation_reasons.map(reason => `<div class="violation-item">${reason}</div>`).join('')}
                    </div>
                ` : ''}
            </div>
        `;
    });
    
    modalBody.innerHTML = contentHtml;
    console.log('‚úÖ OSL Modal content rendered:', data.length, 'items');
}

// 14. Filter modal content functions
function filterTEIModalContent(searchTerm) {
    if (!currentModalData || currentModalData.type !== 'tei') return;
    
    const originalData = currentModalData.data;
    
    if (!searchTerm.trim()) {
        renderTEIModalContent(originalData);
        return;
    }
    
    const filteredData = originalData.filter(item => {
        if (typeof item === 'string') {
            return item.toLowerCase().includes(searchTerm.toLowerCase());
        } else {
            const searchIn = [
                item.vpl_part_reference,
                item.customer_reference,
                item.inner_reference,
                item.part_description
            ].filter(Boolean).join(' ').toLowerCase();
            
            return searchIn.includes(searchTerm.toLowerCase());
        }
    });
    
    renderTEIModalContent(filteredData);
}

function filterOSLModalContent(searchTerm) {
    if (!currentModalData || currentModalData.type !== 'osl') return;
    
    const originalData = currentModalData.data;
    
    if (!searchTerm.trim()) {
        renderOSLModalContent(originalData);
        return;
    }
    
    const filteredData = originalData.filter(item => 
        item.inner_reference && 
        item.inner_reference.toLowerCase().includes(searchTerm.toLowerCase())
    );
    
    renderOSLModalContent(filteredData);
}
function closeModal() {
    const modal = document.getElementById('detailModal');
    if (modal) {
        modal.classList.remove('show');
    }
    currentModalData = null;
    console.log('‚úÖ Modal closed');
}

function updateActiveDate(date) {
    // Date card'larƒ± g√ºncelle
    document.querySelectorAll('.date-card').forEach(card => {
        card.classList.remove('active');
    });
    
    const targetCard = document.querySelector(`[data-date="${date}"]`);
    if (targetCard) {
        targetCard.classList.add('active');
    }
}
function updateTitles(date) {
    const formattedDate = formatDateTurkish(new Date(date));
    const teiTitle = document.getElementById('teiTitle');
    const oslTitle = document.getElementById('oslTitle');
    
    if (teiTitle) teiTitle.textContent = `TEI analizi - ${formattedDate}`;
    if (oslTitle) oslTitle.textContent = `OSL analizi - ${formattedDate}`;

function manualAnalysis() {
    const button = event.target;
    const originalText = button.textContent;
    
    event.preventDefault();
    
    console.log('üî® Manual masterdata analysis triggered');
    
    button.textContent = 'Analiz Yapƒ±lƒ±yor...';
    button.disabled = true;
    
    // ‚úÖ Loading state
    showLoadingState();
    
    // ‚úÖ √ñzel loading mesajƒ±
    const loadingMessage = `
        <div class="loading">
            <div class="spinner"></div>
            Manuel masterdata analizi ba≈ülatƒ±ldƒ±...<br><br>
            1. Eski veriler temizleniyor<br>
            2. TEI/OSL dosyalarƒ± okunuyor<br>
            3. Validation yapƒ±lƒ±yor<br>
            4. Sonu√ßlar hesaplanƒ±yor<br><br>
            L√ºtfen bekleyin...
        </div>
    `;
    
    const teiResults = document.getElementById('teiResults');
    const oslResults = document.getElementById('oslResults');
    if (teiResults) teiResults.innerHTML = loadingMessage;
    if (oslResults) oslResults.innerHTML = loadingMessage;
    
    fetch('/api/masterdata/manual-analysis', { 
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => {
        console.log('üì• Manual analysis response:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('üìä Manual analysis result:', data);
        if (data.success) {
            console.log('‚úÖ Manual masterdata analysis completed');
            
            // ‚úÖ Analiz bitti, yeni veriyi y√ºkle
            const today = new Date().toISOString().split('T')[0];
            setTimeout(() => {
                loadMasterdataAnalysis(today);
            }, 500);
        } else {
            console.error('‚ùå Manual analysis failed:', data.message);
            showErrorState('Manuel analiz ba≈üarƒ±sƒ±z: ' + (data.message || 'Bilinmeyen hata'));
        }
    })
    .catch(error => {
        console.error('‚ùå Manual analysis error:', error);
        showErrorState('Manuel analiz sƒ±rasƒ±nda bir hata olu≈ütu: ' + error.message);
    })
    .finally(() => {
        button.textContent = originalText;
        button.disabled = false;
    });
}}
function updateTitles(date) {
    const formattedDate = formatDateTurkish(new Date(date));
    const teiTitle = document.getElementById('teiTitle');
    const oslTitle = document.getElementById('oslTitle');
    
    if (teiTitle) teiTitle.textContent = `TEI analizi - ${formattedDate}`;
    if (oslTitle) oslTitle.textContent = `OSL analizi - ${formattedDate}`;
}      // Update TEI analysis section
function updateTEIAnalysis(teiResults) {
    console.log('üé® Updating TEI analysis:', teiResults);
    
    if (!teiResults || !teiResults.statistics) {
        console.error('‚ùå Invalid TEI results structure');
        showErrorState('TEI analiz verisi ge√ßersiz');
        return;
    }
    
    const stats = teiResults.statistics;
    
    // TEI statistics g√ºncelle
    const teiStatsHtml = `
        <div class="stat-card">
            <span class="stat-label">VPL Par√ßalarƒ±</span>
            <span class="stat-value">${stats.total_vpl_parts || 0}</span>
        </div>
        <div class="stat-card">
            <span class="stat-label">TEI'de Bulunan</span>
            <span class="stat-value success">${stats.found_in_tei || 0} (${(stats.tei_match_rate || 0).toFixed(1)}%)</span>
        </div>
        <div class="stat-card">
            <span class="stat-label">Inner Ref Doƒüruluƒüu</span>
            <span class="stat-value ${(stats.inner_ref_accuracy || 0) > 90 ? 'success' : 'warning'}">${(stats.inner_ref_accuracy || 0).toFixed(1)}%</span>
        </div>
        <div class="stat-card">
            <span class="stat-label">A√ßƒ±klama Kapsamƒ±</span>
            <span class="stat-value ${(stats.description_coverage || 0) > 90 ? 'success' : 'warning'}">${(stats.description_coverage || 0).toFixed(1)}%</span>
        </div>
    `;
    
    const teiStatsElement = document.getElementById('teiStats');
    if (teiStatsElement) {
        teiStatsElement.innerHTML = teiStatsHtml;
        console.log('‚úÖ TEI stats updated');
    }

    // TEI results g√ºncelle - FIX: onclick events properly bound
    let teiResultsHtml = '';
    
    // TEI'de bulunamayan par√ßalar
    if (teiResults.not_found_in_tei && teiResults.not_found_in_tei.length > 0) {
        teiResultsHtml += `
            <div class="result-item error">
                <div class="result-header">
                    <div class="result-info">
                        <div class="result-title">TEI'de Bulunamayan Par√ßalar</div>
                        <div class="result-count">${teiResults.not_found_in_tei.length}</div>
                    </div>
                    <button class="details-btn" onclick="openTEIModal('not_found')">Detaylarƒ± G√∂r</button>
                </div>
                <div class="result-description">TEI dosyasƒ±nda kar≈üƒ±lƒ±ƒüƒ± bulunmayan VPL par√ßalarƒ±</div>
            </div>
        `;
    }

    // Inner Reference hatalarƒ±
    if (teiResults.inner_reference_incorrect && teiResults.inner_reference_incorrect.length > 0) {
        teiResultsHtml += `
            <div class="result-item warning">
                <div class="result-header">
                    <div class="result-info">
                        <div class="result-title">Inner Reference Hatalarƒ±</div>
                        <div class="result-count">${teiResults.inner_reference_incorrect.length}</div>
                    </div>
                    <button class="details-btn" onclick="openTEIModal('inner_ref_errors')">Detaylarƒ± G√∂r</button>
                </div>
                <div class="result-description">Yanlƒ±≈ü inner reference formatƒ±na sahip par√ßalar</div>
            </div>
        `;
    }

    // Eksik a√ßƒ±klamalar
    if (teiResults.missing_description && teiResults.missing_description.length > 0) {
        teiResultsHtml += `
            <div class="result-item warning">
                <div class="result-header">
                    <div class="result-info">
                        <div class="result-title">Eksik A√ßƒ±klamalar</div>
                        <div class="result-count">${teiResults.missing_description.length}</div>
                    </div>
                    <button class="details-btn" onclick="openTEIModal('missing_desc')">Detaylarƒ± G√∂r</button>
                </div>
                <div class="result-description">A√ßƒ±klama bilgisi eksik olan par√ßalar</div>
            </div>
        `;
    }

    if (teiResultsHtml === '') {
        teiResultsHtml = `
            <div class="empty-state">
                <h3>üìÑ TEI analiz completed</h3>
                <p>T√ºm kontroller ba≈üarƒ±lƒ±, herhangi bir sorun bulunamadƒ±.</p>
            </div>
        `;
    }

    const teiResultsElement = document.getElementById('teiResults');
    if (teiResultsElement) {
        teiResultsElement.innerHTML = teiResultsHtml;
        console.log('‚úÖ TEI results updated');
    }
}
        // Update OSL analiz section  
     function updateOSLAnalysis(oslResults) {
    console.log('üé® Updating OSL analysis:', oslResults);
    
    if (!oslResults || !oslResults.statistics) {
        console.error('‚ùå Invalid OSL results structure');
        showErrorState('OSL analysis verisi ge√ßersiz');
        return;
    }
    
    const stats = oslResults.statistics;
    
    // OSL statistics g√ºncelle
    const oslStatsHtml = `
        <div class="stat-card">
            <span class="stat-label">Inner Reference</span>
            <span class="stat-value">${stats.total_inner_references || 0}</span>
        </div>
        <div class="stat-card">
            <span class="stat-label">OSL'de Bulunan</span>
            <span class="stat-value success">${stats.found_in_osl || 0} (${(stats.osl_match_rate || 0).toFixed(1)}%)</span>
        </div>
        <div class="stat-card">
            <span class="stat-label">Parametre Tamamlama</span>
            <span class="stat-value ${(stats.parameter_completeness || 0) > 80 ? 'success' : 'warning'}">${(stats.parameter_completeness || 0).toFixed(1)}%</span>
        </div>
        <div class="stat-card">
            <span class="stat-label">CK Mod√ºl√º Uyumluluƒüu</span>
            <span class="stat-value ${(stats.ck_compliance_rate || 0) > 80 ? 'success' : 'error'}">${(stats.ck_compliance_rate || 0).toFixed(1)}%</span>
        </div>
    `;
    
    const oslStatsElement = document.getElementById('oslStats');
    if (oslStatsElement) {
        oslStatsElement.innerHTML = oslStatsHtml;
        console.log('‚úÖ OSL stats updated');
    }

    // OSL results g√ºncelle - FIX: onclick events properly bound
    let oslResultsHtml = '';
    
    if (oslResults.validation_statistics) {
        const validationStats = oslResults.validation_statistics;
        
        // Genel uyumluluk
        oslResultsHtml += `
            <div class="result-item ${(validationStats.overall_compliance_rate || 0) > 80 ? 'success' : 'warning'}">
                <div class="result-header">
                    <div class="result-info">
                        <div class="result-title">Genel Uyumluluk</div>
                        <div class="result-count">${validationStats.fully_compliant_parts || 0}/${validationStats.total_parts || 0}</div>
                    </div>
                    <button class="details-btn" onclick="openOSLModal('all_validation')">Detaylarƒ± G√∂r</button>
                </div>
                <div class="result-description">T√ºm validation kurallarƒ±na uygun par√ßalar (${(validationStats.overall_compliance_rate || 0).toFixed(1)}%)</div>
            </div>
        `;

        // Required parametre violations
        if ((validationStats.required_param_violations || 0) > 0) {
            oslResultsHtml += `
                <div class="result-item error">
                    <div class="result-header">
                        <div class="result-info">
                            <div class="result-title">Required Parametre Eksikleri</div>
                            <div class="result-count">${validationStats.required_param_violations}</div>
                        </div>
                        <button class="details-btn" onclick="openOSLModal('required_violations')">Detaylarƒ± G√∂r</button>
                    </div>
                    <div class="result-description">MODULE veya PART_FAMILY eksik olan par√ßalar</div>
                </div>
            `;
        }

        // CK module violations
        if ((validationStats.ck_module_violations || 0) > 0) {
            oslResultsHtml += `
                <div class="result-item error">
                    <div class="result-header">
                        <div class="result-info">
                            <div class="result-title">CK Mod√ºl√º Violation'larƒ±</div>
                            <div class="result-count">${validationStats.ck_module_violations}</div>
                        </div>
                        <button class="details-btn" onclick="openOSLModal('ck_violations')">Detaylarƒ± G√∂r</button>
                    </div>
                    <div class="result-description">CK mod√ºl√º i√ßin LABEL_POSITION/LABEL_TYPE eksik</div>
                </div>
            `;
        }
    }

    if (oslResultsHtml === '') {
        oslResultsHtml = `
            <div class="empty-state">
                <h3>‚öôÔ∏è OSL analysis completed</h3>
                <p>T√ºm validation kurallarƒ± ba≈üarƒ±lƒ±, violation bulunamadƒ±.</p>
            </div>
        `;
    }

    const oslResultsElement = document.getElementById('oslResults');
    if (oslResultsElement) {
        oslResultsElement.innerHTML = oslResultsHtml;
        console.log('‚úÖ OSL results updated');
    }
}




        // Update compliance overview
        function updateComplianceOverview(analysisData) {
    console.log('üé® Updating compliance overview');
    
    try {
        if (analysisData.osl_analysis_results && analysisData.osl_analysis_results.validation_statistics) {
            const stats = analysisData.osl_analysis_results.validation_statistics;
            const score = stats.overall_compliance_rate || 0;
            
            // Score circle g√ºncelle
            updateScoreCircle(score);
            const scoreElement = document.getElementById('scoreText');
            if (scoreElement) {
                scoreElement.textContent = `${score.toFixed(0)}%`;
            }
            
            // Breakdown g√ºncelle
            const breakdownHtml = `
                <div class="breakdown-item">
                    <span class="breakdown-label">Required Parametreler</span>
                    <span class="breakdown-value ${(stats.required_param_compliance_rate || 0) > 90 ? 'success' : 'error'}">${(stats.required_param_compliance_rate || 0).toFixed(1)}%</span>
                </div>
                <div class="breakdown-item">
                    <span class="breakdown-label">PROJECT Parametreleri</span>
                    <span class="breakdown-value ${(stats.project_compliance_rate || 0) > 90 ? 'success' : 'warning'}">${(stats.project_compliance_rate || 0).toFixed(1)}%</span>
                </div>
                <div class="breakdown-item">
                    <span class="breakdown-label">CK Mod√ºl Uyumluluƒüu</span>
                    <span class="breakdown-value ${(stats.ck_compliance_rate || 0) > 80 ? 'success' : 'error'}">${(stats.ck_compliance_rate || 0).toFixed(1)}%</span>
                </div>
            `;
            
            const breakdownElement = document.getElementById('complianceBreakdown');
            if (breakdownElement) {
                breakdownElement.innerHTML = breakdownHtml;
            }
            
            // CK stats g√ºncelle
            const ckStatsHtml = `
                <div class="ck-stat">
                    <span class="ck-stat-label">CK Mod√ºl√º Par√ßa:</span>
                    <span class="ck-stat-value">${stats.ck_module_parts || 0}</span>
                </div>
                <div class="ck-stat">
                    <span class="ck-stat-label">CK Violation:</span>
                    <span class="ck-stat-value">${stats.ck_module_violations || 0}</span>
                </div>
                <div class="ck-stat">
                    <span class="ck-stat-label">CK Uyumluluk:</span>
                    <span class="ck-stat-value">${(stats.ck_compliance_rate || 0).toFixed(1)}%</span>
                </div>
            `;
            
            const ckStatsElement = document.getElementById('ckStats');
            if (ckStatsElement) {
                ckStatsElement.innerHTML = ckStatsHtml;
            }
            
            console.log('‚úÖ Compliance overview updated');
        } else {
            console.warn('‚ö†Ô∏è No validation statistics found for compliance overview');
        }
    } catch (error) {
        console.error('‚ùå Error updating compliance overview:', error);
    }
}

        // Modal functions for OSL results
        function openOSLModal(type) {
            if (!currentAnalysisData) return;
            
            const modal = document.getElementById('detailModal');
            const modalTitle = document.getElementById('modalTitle');
            const searchInput = document.getElementById('searchInput');
            
            let titleText = '';
            let data = [];
            
            const oslResults = currentAnalysisData.osl_analysis_results;
            
            if (oslResults.validation_results) {
                switch (type) {
                    case 'all_validation':
                        titleText = `T√ºm Validation Sonu√ßlarƒ± (${oslResults.validation_results.length})`;
                        data = oslResults.validation_results;
                        break;
                    case 'required_violations':
                        titleText = `Required Parametre Violation'larƒ±`;
                        data = oslResults.validation_results.filter(r => !r.required_compliance.is_compliant);
                        break;
                    case 'project_violations':
                        titleText = `PROJECT Parametre Violation'larƒ±`;
                        data = oslResults.validation_results.filter(r => !r.project_compliance.is_compliant);
                        break;
                    case 'ck_violations':
                        titleText = `CK Mod√ºl√º Violation'larƒ±`;
                        data = oslResults.validation_results.filter(r => r.ck_module_compliance.is_ck_module && !r.ck_module_compliance.is_compliant);
                        break;
                }
            }
            
            modalTitle.textContent = titleText;
            searchInput.value = '';
            searchInput.placeholder = 'üîç Inner reference ara...';
            
            currentModalData = { type: 'osl', subtype: type, data: data };
            renderOSLModalContent(data);
            
            searchInput.oninput = () => filterOSLModalContent(searchInput.value);
            modal.classList.add('show');
        }

        // Render TEI modal content
        function renderTEIModalContent(data) {
            const modalBody = document.getElementById('modalBody');
            const resultsCount = document.getElementById('resultsCount');
            
            if (!data || data.length === 0) {
                modalBody.innerHTML = '<div class="empty-state"><h3>Sonu√ß bulunamadƒ±</h3></div>';
                resultsCount.textContent = 'Toplam: 0 sonu√ß';
                return;
            }
            
            resultsCount.textContent = `Toplam: ${data.length} sonu√ß`;
            
            let contentHtml = '';
            
            data.forEach((item, index) => {
                if (typeof item === 'string') {
                    // Simple string data (not found items)
                    contentHtml += `
                        <div class="modal-item">
                            <div class="modal-item-header">Part ${index + 1}: ${item}</div>
                            <div class="modal-item-content">
                                <div class="modal-item-field">
                                    <span class="field-label">VPL Referansƒ±:</span>
                                    <span class="field-value error">${item}</span>
                                </div>
                                <div class="modal-item-field">
                                    <span class="field-label">Durum:</span>
                                    <span class="field-value error">TEI'de bulunamadƒ±</span>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // Object data (found items, validation errors, etc.)
                    let statusClass = 'success';
                    let statusText = 'Uyumlu';
                    
                    if (item.error_reason) {
                        statusClass = 'error';
                        statusText = 'Hata';
                    } else if (!item.description_exists) {
                        statusClass = 'warning';
                        statusText = 'Eksik a√ßƒ±klama';
                    }
                    
                    contentHtml += `
                        <div class="modal-item">
                            <div class="modal-item-header">${item.vpl_part_reference || item.customer_reference}</div>
                            <div class="modal-item-content">
                                <div class="modal-item-field">
                                    <span class="field-label">Customer Reference:</span>
                                    <span class="field-value">${item.customer_reference || '-'}</span>
                                </div>
                                <div class="modal-item-field">
                                    <span class="field-label">Inner Reference:</span>
                                    <span class="field-value">${item.inner_reference || '-'}</span>
                                </div>
                                <div class="modal-item-field">
                                    <span class="field-label">Part A√ßƒ±klamasƒ±:</span>
                                    <span class="field-value">${item.part_description || 'Yok'}</span>
                                </div>
                                <div class="modal-item-field">
                                    <span class="field-label">Durum:</span>
                                    <span class="field-value ${statusClass}">${statusText}</span>
                                </div>
                                ${item.expected_inner ? `
                                    <div class="modal-item-field">
                                        <span class="field-label">Beklenen Inner:</span>
                                        <span class="field-value warning">${item.expected_inner}</span>
                                    </div>
                                    <div class="modal-item-field">
                                        <span class="field-label">Ger√ßek Inner:</span>
                                        <span class="field-value error">${item.actual_inner}</span>
                                    </div>
                                ` : ''}
                            </div>
                            ${item.error_reason ? `
                                <div class="violations-list">
                                    <div class="violation-item">${item.error_reason}</div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }
            });
            
            modalBody.innerHTML = contentHtml;
        }

        // Render OSL modal content
        function renderOSLModalContent(data) {
            const modalBody = document.getElementById('modalBody');
            const resultsCount = document.getElementById('resultsCount');
            
            if (!data || data.length === 0) {
                modalBody.innerHTML = '<div class="empty-state"><h3>Sonu√ß bulunamadƒ±</h3></div>';
                resultsCount.textContent = 'Toplam: 0 sonu√ß';
                return;
            }
            
            resultsCount.textContent = `Toplam: ${data.length} sonu√ß`;
            
            let contentHtml = '';
            
            data.forEach((item, index) => {
                const complianceClass = item.overall_compliance ? 'success' : 'error';
                const complianceText = item.overall_compliance ? 'Uyumlu' : 'Violation Var';
                
                contentHtml += `
                    <div class="modal-item">
                        <div class="modal-item-header">${item.inner_reference}</div>
                        <div class="modal-item-content">
                            <div class="modal-item-field">
                                <span class="field-label">Compliance Score:</span>
                                <span class="field-value ${complianceClass}">${item.compliance_score?.toFixed(1) || 0}%</span>
                            </div>
                            <div class="modal-item-field">
                                <span class="field-label">Genel Durum:</span>
                                <span class="field-value ${complianceClass}">${complianceText}</span>
                            </div>
                            <div class="modal-item-field">
                                <span class="field-label">MODULE:</span>
                                <span class="field-value ${item.required_compliance?.has_module ? 'success' : 'error'}">${item.required_compliance?.module_value || 'Yok'}</span>
                            </div>
                            <div class="modal-item-field">
                                <span class="field-label">PART_FAMILY:</span>
                                <span class="field-value ${item.required_compliance?.has_part_family ? 'success' : 'error'}">${item.required_compliance?.part_family_value || 'Yok'}</span>
                            </div>
                            <div class="modal-item-field">
                                <span class="field-label">PROJECT:</span>
                                <span class="field-value ${item.project_compliance?.has_project ? 'success' : 'warning'}">${item.project_compliance?.project_value || 'Yok'}</span>
                            </div>
                            <div class="modal-item-field">
                                <span class="field-label">PROJECT1:</span>
                                <span class="field-value ${item.project_compliance?.has_project1 ? 'success' : 'warning'}">${item.project_compliance?.project1_value || 'Yok'}</span>
                            </div>
                            ${item.ck_module_compliance?.is_ck_module ? `
                                <div class="modal-item-field">
                                    <span class="field-label">LABEL_POSITION:</span>
                                    <span class="field-value ${item.ck_module_compliance.has_label_position ? 'success' : 'error'}">${item.ck_module_compliance.label_position_value || 'Yok'}</span>
                                </div>
                                <div class="modal-item-field">
                                    <span class="field-label">LABEL_TYPE:</span>
                                    <span class="field-value ${item.ck_module_compliance.has_label_type ? 'success' : 'error'}">${item.ck_module_compliance.label_type_value || 'Yok'}</span>
                                </div>
                            ` : ''}
                        </div>
                        ${item.violation_reasons && item.violation_reasons.length > 0 ? `
                            <div class="violations-list">
                                ${item.violation_reasons.map(reason => `<div class="violation-item">${reason}</div>`).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            modalBody.innerHTML = contentHtml;
        }

        // Filter modal content
        function filterTEIModalContent(searchTerm) {
            if (!currentModalData || currentModalData.type !== 'tei') return;
            
            const originalData = currentModalData.data;
            
            if (!searchTerm.trim()) {
                renderTEIModalContent(originalData);
                return;
            }
            
            const filteredData = originalData.filter(item => {
                if (typeof item === 'string') {
                    return item.toLowerCase().includes(searchTerm.toLowerCase());
                } else {
                    return (item.vpl_part_reference && item.vpl_part_reference.toLowerCase().includes(searchTerm.toLowerCase())) ||
                           (item.customer_reference && item.customer_reference.toLowerCase().includes(searchTerm.toLowerCase())) ||
                           (item.inner_reference && item.inner_reference.toLowerCase().includes(searchTerm.toLowerCase()));
                }
            });
            
            renderTEIModalContent(filteredData);
        }

        function filterOSLModalContent(searchTerm) {
            if (!currentModalData || currentModalData.type !== 'osl') return;
            
            const originalData = currentModalData.data;
            
            if (!searchTerm.trim()) {
                renderOSLModalContent(originalData);
                return;
            }
            
            const filteredData = originalData.filter(item => 
                item.inner_reference.toLowerCase().includes(searchTerm.toLowerCase())
            );
            
            renderOSLModalContent(filteredData);
        }

        // Apply filter
        // 6. Modal Filter Functions - Fixed
function applyFilter() {
    const filterValue = document.getElementById('filterSelect').value;
    
    if (!currentModalData) return;
    
    let filteredData = currentModalData.data;
    
    if (currentModalData.type === 'osl' && filterValue !== 'all') {
        if (filterValue === 'violations') {
            filteredData = currentModalData.data.filter(item => !item.overall_compliance);
        } else if (filterValue === 'compliant') {
            filteredData = currentModalData.data.filter(item => item.overall_compliance);
        }
    }
    
    if (currentModalData.type === 'tei') {
        renderTEIModalContent(filteredData);
    } else {
        renderOSLModalContent(filteredData);
    }
}

        function closeModal() {
    const modal = document.getElementById('detailModal');
    if (modal) {
        modal.classList.remove('show');
    }
    currentModalData = null;
    console.log('‚úÖ Modal closed');
}

        // Export modal data to CSV
        function exportModalData() {
    if (!currentModalData || !currentModalData.data) {
        alert('Export edilecek veri bulunamadƒ±');
        return;
    }
    
    let csvContent = '';
    let filename = `masterdata_${currentModalData.type}_${new Date().toISOString().split('T')[0]}.csv`;
    
    if (currentModalData.type === 'tei') {
        csvContent = 'VPL Reference,Customer Reference,Inner Reference,Part Description,Status\n';
        currentModalData.data.forEach(item => {
            if (typeof item === 'string') {
                csvContent += `"${item}","","","","TEI'de bulunamadƒ±"\n`;
            } else {
                const status = item.error_reason || item.status || 'Uyumlu';
                csvContent += `"${item.vpl_part_reference || ''}","${item.customer_reference || ''}","${item.inner_reference || ''}","${item.part_description || ''}","${status}"\n`;
            }
        });
    } else if (currentModalData.type === 'osl') {
        csvContent = 'Inner Reference,Compliance Score,Overall Status,MODULE,PART_FAMILY,PROJECT,PROJECT1,Violations\n';
        currentModalData.data.forEach(item => {
            const violations = item.violation_reasons ? item.violation_reasons.join('; ') : '';
            csvContent += `"${item.inner_reference || ''}","${item.compliance_score?.toFixed(1) || 0}%","${item.overall_compliance ? 'Uyumlu' : 'Violation'}","${item.required_compliance?.module_value || ''}","${item.required_compliance?.part_family_value || ''}","${item.project_compliance?.project_value || ''}","${item.project_compliance?.project1_value || ''}","${violations}"\n`;
        });
    }
    
    // Create and download file
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', filename);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    console.log('‚úÖ Data exported:', filename);
}

        // Loading and error states
        function showLoadingState() {
    const loadingHtml = '<div class="loading">Loading analysis data...</div>';
    
    const teiStats = document.getElementById('teiStats');
    const teiResults = document.getElementById('teiResults');
    const oslStats = document.getElementById('oslStats');
    const oslResults = document.getElementById('oslResults');
    
    if (teiStats) teiStats.innerHTML = loadingHtml;
    if (teiResults) teiResults.innerHTML = loadingHtml;
    if (oslStats) oslStats.innerHTML = loadingHtml;
    if (oslResults) oslResults.innerHTML = loadingHtml;
}

        function showErrorState(message) {
    const errorHtml = `
        <div class="empty-state">
            <h3>‚ö†Ô∏è Veri Y√ºklenemedi</h3>
            <p>${message}</p>
        </div>
    `;
    
    const teiResults = document.getElementById('teiResults');
    const oslResults = document.getElementById('oslResults');
    
    if (teiResults) teiResults.innerHTML = errorHtml;
    if (oslResults) oslResults.innerHTML = errorHtml;
}

        // Navigation functions
        function goBack() {
            window.location.href = '/selection';
        }

        
        // Manual analysis
        function manualAnalysis() {
            const button = event.target;
            const originalText = button.textContent;
            
            event.preventDefault();
            
            console.log('üî® Manual masterdata analysis triggered');
            
            button.textContent = 'analysis Ediliyor...';
            button.disabled = true;
            
            fetch('/api/masterdata/manual-analysis', { 
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => {
                console.log('üì• Manual analysis response:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('üìä Manual analysis result:', data);
                if (data.success) {
                    console.log('‚úÖ Manual masterdata analysis completed');
                    // Refresh current analysis
                    const today = new Date().toISOString().split('T')[0];
                    setTimeout(() => {
                        loadMasterdataAnalysis(today);
                    }, 1000);
                } else {
                    console.error('‚ùå Manual analysis failed:', data.message);
                    alert('Manuel analysis ba≈üarƒ±sƒ±z: ' + (data.message || 'Bilinmeyen hata'));
                }
            })
            .catch(error => {
                console.error('‚ùå Manual analysis error:', error);
                alert('Manuel analysis sƒ±rasƒ±nda bir hata olu≈ütu: ' + error.message);
            })
            .finally(() => {
                button.textContent = originalText;
                button.disabled = false;
            });
        }

        // Reanalyze specific date
        function reanalyze(date) {
            const button = event.target;
            const originalText = button.textContent;
            
            button.textContent = '‚ü≥';
            button.style.animation = 'spin 1s infinite linear';
            
            fetch('/api/masterdata/reanalyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ date: date })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadMasterdataAnalysis(date);
                } else {
                    alert('Yeniden analysis ba≈üarƒ±sƒ±z: ' + (data.message || 'Bilinmeyen hata'));
                }
            })
            .catch(error => {
                console.error('Reanalyze error:', error);
                alert('Yeniden analysis sƒ±rasƒ±nda bir hata olu≈ütu');
            })
            .finally(() => {
                button.textContent = originalText;
                button.style.animation = '';
            });
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            // Generate dynamic date cards for last 7 days
            generateDateCards();
            
            // Load current date analysis
            const today = new Date().toISOString().split('T')[0];
            loadMasterdataAnalysis(today);
            
            // Set current user
            document.getElementById('currentUser').textContent = 'Admin';
            
            // Close modal when clicking outside
            document.getElementById('detailModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal();
                }
            });
            
            // Close modal with Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeModal();
                }
            });
        });

        // Generate date cards dynamically
        function generateDateCards() {
    const container = document.getElementById('dateCards');
    const today = new Date();
    
    // Generate cards for last 5 days (VPL gibi)
    for (let i = 0; i < 5; i++) {
        const date = new Date(today);
        date.setDate(today.getDate() - i);
        
        const dateStr = date.toISOString().split('T')[0];
        const displayDate = formatDateTurkish(date);
        
        // √ñnceki g√ºn hesapla (comparison i√ßin)
        const previousDate = new Date(date);
        previousDate.setDate(date.getDate() - 1);
        const previousDisplayDate = formatDateTurkish(previousDate);
        
        const cardHTML = `
            <div class="date-card ${i === 0 ? 'active' : ''}" data-date="${dateStr}" onclick="loadMasterdataAnalysis('${dateStr}')">
                <div class="date-text">${displayDate}</div>
                <div class="date-details">vs ${previousDisplayDate}</div>
                <button class="reanalyze-btn" onclick="event.stopPropagation(); reanalyze('${dateStr}')">‚Üª</button>
            </div>
        `;
        
        container.innerHTML += cardHTML;
    }
}
        // Format date in Turkish
        function formatDateTurkish(date) {
            const months = [
                'Ocak', '≈ûubat', 'Mart', 'Nisan', 'Mayƒ±s', 'Haziran',
                'Temmuz', 'Aƒüustos', 'Eyl√ºl', 'Ekim', 'Kasƒ±m', 'Aralƒ±k'
            ];
            
            const day = date.getDate();
            const month = months[date.getMonth()];
            const year = date.getFullYear();
            
            return `${day} ${month} ${year}`;
        }

        // Add CSS animation for spinning
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                0% { transform: translateY(-50%) rotate(0deg); }
                100% { transform: translateY(-50%) rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>